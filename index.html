<!doctype html>
<html lang="th">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=initial-scale=1.0">
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <style>
    body {
      box-sizing: border-box;
      font-family: 'Sarabun', 'Sukhumvit Set', Arial, sans-serif;
    }
    * {
      box-sizing: border-box;
    }
    .fade-in {
      animation: fadeIn 0.3s ease-in;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .spinner {
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top: 3px solid white;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
 </head>
 <body class="h-full w-full overflow-auto">
  <div id="app" class="h-full w-full"></div>
  <div id="loading-overlay" class="loading-overlay hidden">
   <div class="bg-white rounded-lg p-6 flex flex-col items-center gap-3">
    <div class="spinner" style="border-top-color: #3b82f6; border-width: 4px; width: 40px; height: 40px;"></div>
    <p class="text-gray-700 font-medium">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
   </div>
  </div>
  <script>
    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyD98l2HfqhFhrKIsL3Rl88dSHFKbVm8wMA",
      authDomain: "saha-pvc-auth.firebaseapp.com",
      projectId: "saha-pvc-auth",
      storageBucket: "saha-pvc-auth.firebasestorage.app",
      messagingSenderId: "510907547342",
      appId: "1:510907547342:web:dbeb44ed7465789ce31a9f",
      measurementId: "G-G5E6QFS2JQ"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Helper function ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏õ‡∏±‡∏î‡πÄ‡∏®‡∏©‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏° 2 ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á
    function roundTo2Decimal(num) {
      return Math.round(num * 100) / 100;
    }

    // Helper function ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÅ‡∏ö‡∏ö‡∏°‡∏µ‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏° 2 ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á
    function formatNumber(num) {
      return num.toLocaleString('th-TH', {minimumFractionDigits: 2, maximumFractionDigals: 2});
    }

    // Helper function ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô DD/MM/YYYY (‡∏û.‡∏®.)
    function formatDateThai(dateString) {
      if (!dateString) return '-';
      const date = new Date(dateString);
      const day = String(date.getDate()).padStart(2, '0');
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const year = date.getFullYear() + 543; // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô ‡∏û.‡∏®.
      return `${day}/${month}/${year}`;
    }

    // Helper function ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡πá‡∏ô DD/MM/YYYY HH:MM (‡∏û.‡∏®.)
    function formatDateTimeThai(timestamp) {
      if (!timestamp) return '-';
      const date = new Date(timestamp.toDate());
      const day = String(date.getDate()).padStart(2, '0');
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const year = date.getFullYear() + 543; // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô ‡∏û.‡∏®.
      const hours = String(date.getHours()).padStart(2, '0');
      const minutes = String(date.getMinutes()).padStart(2, '0');
      return `${day}/${month}/${year} ${hours}:${minutes}`;
    }

    // Helper function ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏õ‡∏•‡∏á input date (YYYY-MM-DD) ‡πÄ‡∏õ‡πá‡∏ô DD/MM/YYYY (‡∏û.‡∏®.)
    function convertInputDateToDisplay(inputDate) {
      if (!inputDate) return '‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ';
      const [year, month, day] = inputDate.split('-');
      const thaiYear = parseInt(year) + 543;
      return `${day}/${month}/${thaiYear}`;
    }

    // Helper function ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏õ‡∏•‡∏á Excel date number ‡πÄ‡∏õ‡πá‡∏ô YYYY-MM-DD (‡πÉ‡∏ä‡πâ UTC ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤ timezone)
    function excelDateToYMD(excelDate) {
      const excelEpoch = new Date(Date.UTC(1899, 11, 30));
      const date = new Date(excelEpoch.getTime() + excelDate * 86400000);
      const year = date.getUTCFullYear();
      const month = String(date.getUTCMonth() + 1).padStart(2, '0');
      const day = String(date.getUTCDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    // Default Config
    const defaultConfig = {
      app_title: "‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤",
      company_name: "SAHA P.V.C. (1980) Limited Partnership",
      primary_color: "#3b82f6",
      secondary_color: "#ffffff",
      text_color: "#1f2937",
      success_color: "#10b981",
      danger_color: "#ef4444",
      font_family: "Sarabun",
      font_size: 16
    };

    // State Management
    let currentUser = null;
    let currentMenu = 'dashboard';
    let products = [];
    let stockMovements = [];
    let productStockByIV = {};

    // Loading State Management
    function showLoading() {
      document.getElementById('loading-overlay').classList.remove('hidden');
    }

    function hideLoading() {
      document.getElementById('loading-overlay').classList.add('hidden');
    }

    // Initialize Element SDK
    async function initElementSDK() {
      if (window.elementSdk) {
        await window.elementSdk.init({
          defaultConfig: defaultConfig,
          onConfigChange: async (config) => {
            applyConfigToUI(config);
          },
          mapToCapabilities: (config) => ({
            recolorables: [
              {
                get: () => config.primary_color || defaultConfig.primary_color,
                set: (value) => {
                  config.primary_color = value;
                  window.elementSdk.setConfig({ primary_color: value });
                }
              },
              {
                get: () => config.secondary_color || defaultConfig.secondary_color,
                set: (value) => {
                  config.secondary_color = value;
                  window.elementSdk.setConfig({ secondary_color: value });
                }
              },
              {
                get: () => config.text_color || defaultConfig.text_color,
                set: (value) => {
                  config.text_color = value;
                  window.elementSdk.setConfig({ text_color: value });
                }
              },
              {
                get: () => config.success_color || defaultConfig.success_color,
                set: (value) => {
                  config.success_color = value;
                  window.elementSdk.setConfig({ success_color: value });
                }
              },
              {
                get: () => config.danger_color || defaultConfig.danger_color,
                set: (value) => {
                  config.danger_color = value;
                  window.elementSdk.setConfig({ danger_color: value });
                }
              }
            ],
            borderables: [],
            fontEditable: {
              get: () => config.font_family || defaultConfig.font_family,
              set: (value) => {
                config.font_family = value;
                window.elementSdk.setConfig({ font_family: value });
              }
            },
            fontSizeable: {
              get: () => config.font_size || defaultConfig.font_size,
              set: (value) => {
                config.font_size = value;
                window.elementSdk.setConfig({ font_size: value });
              }
            }
          }),
          mapToEditPanelValues: (config) => new Map([
            ["app_title", config.app_title || defaultConfig.app_title],
            ["company_name", config.company_name || defaultConfig.company_name]
          ])
        });
      }
    }

    function applyConfigToUI(config) {
      const primaryColor = config.primary_color || defaultConfig.primary_color;
      const secondaryColor = config.secondary_color || defaultConfig.secondary_color;
      const textColor = config.text_color || defaultConfig.text_color;
      const successColor = config.success_color || defaultConfig.success_color;
      const dangerColor = config.danger_color || defaultConfig.danger_color;
      const fontFamily = config.font_family || defaultConfig.font_family;
      const fontSize = config.font_size || defaultConfig.font_size;

      document.body.style.fontFamily = `${fontFamily}, 'Sukhumvit Set', Arial, sans-serif`;
      document.body.style.fontSize = `${fontSize}px`;
      document.body.style.color = textColor;

      const appTitle = document.getElementById('app-title');
      if (appTitle) appTitle.textContent = config.app_title || defaultConfig.app_title;

      const companyName = document.getElementById('company-name');
      if (companyName) companyName.textContent = config.company_name || defaultConfig.company_name;

      document.querySelectorAll('.btn-primary').forEach(el => {
        el.style.backgroundColor = primaryColor;
      });

      document.querySelectorAll('.btn-success').forEach(el => {
        el.style.backgroundColor = successColor;
      });

      document.querySelectorAll('.btn-danger').forEach(el => {
        el.style.backgroundColor = dangerColor;
      });

      document.querySelectorAll('.bg-primary').forEach(el => {
        el.style.backgroundColor = primaryColor;
      });

      document.querySelectorAll('.text-primary').forEach(el => {
        el.style.color = primaryColor;
      });

      document.querySelectorAll('.card').forEach(el => {
        el.style.backgroundColor = secondaryColor;
      });
    }

    // Authentication Functions
    async function handleLogin(email, password) {
      try {
        await auth.signInWithEmailAndPassword(email, password);
        return { success: true };
      } catch (error) {
        return { success: false, error: error.message };
      }
    }

    async function handleLogout() {
      try {
        await auth.signOut();
        currentUser = null;
        renderApp();
      } catch (error) {
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö', 'error');
      }
    }

    // Firestore Data Functions
    async function loadProducts() {
      try {
        const snapshot = await db.collection('products').get();
        products = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        products.sort((a, b) => {
          const aMatch = a.name.match(/^(\d+)/);
          const bMatch = b.name.match(/^(\d+)/);
          
          if (aMatch && bMatch) {
            const aNum = parseInt(aMatch[1]);
            const bNum = parseInt(bMatch[1]);
            if (aNum !== bNum) {
              return aNum - bNum;
            }
          }
          
          return a.name.localeCompare(b.name, 'th');
        });
        return products;
      } catch (error) {
        console.error('Error loading products:', error);
        return [];
      }
    }

    async function loadStockMovements() {
      try {
        const snapshot = await db.collection('stockMovements').orderBy('timestamp', 'desc').get();
        stockMovements = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        calculateStockByIV();
        return stockMovements;
      } catch (error) {
        console.error('Error loading movements:', error);
        return [];
      }
    }

    function calculateStockByIV() {
      productStockByIV = {};
      
      stockMovements.forEach(movement => {
        const productId = movement.productId;
        const ivNumber = movement.ivNumber;
        
        if (!productStockByIV[productId]) {
          productStockByIV[productId] = {};
        }
        
        if (!productStockByIV[productId][ivNumber]) {
          productStockByIV[productId][ivNumber] = 0;
        }
        
        if (movement.type === 'receive') {
          productStockByIV[productId][ivNumber] += movement.quantity;
        } else if (movement.type === 'issue') {
          productStockByIV[productId][ivNumber] -= movement.quantity;
        }
        
        // ‡∏õ‡∏±‡∏î‡πÄ‡∏õ‡πá‡∏ô 2 ‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏°
        productStockByIV[productId][ivNumber] = roundTo2Decimal(productStockByIV[productId][ivNumber]);
      });
    }

    function getCurrentStock(productId) {
      let total = 0;
      stockMovements
        .filter(m => m.productId === productId)
        .forEach(m => {
          if (m.type === 'receive') total += m.quantity;
          else if (m.type === 'issue') total -= m.quantity;
        });
      return roundTo2Decimal(total);
    }

    function getAvailableIVs(productId) {
      const ivStock = productStockByIV[productId] || {};
      return Object.entries(ivStock)
        .filter(([iv, qty]) => qty > 0)
        .map(([iv, qty]) => ({ iv, qty: roundTo2Decimal(qty) }));
    }

    async function addProduct(productData) {
      try {
        const duplicate = products.find(p => p.name.toLowerCase() === productData.name.toLowerCase());
        if (duplicate) {
          return { success: false, error: '‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß' };
        }
        
        if (!productData.name || !productData.unit) {
          return { success: false, error: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô' };
        }
        
        if (productData.minStock < 0) {
          return { success: false, error: '‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ö‡∏ß‡∏Å' };
        }
        
        showLoading();
        await db.collection('products').add({
          ...productData,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        await loadProducts();
        hideLoading();
        return { success: true };
      } catch (error) {
        hideLoading();
        return { success: false, error: error.message };
      }
    }

    async function updateProduct(productId, updates) {
      try {
        showLoading();
        await db.collection('products').doc(productId).update(updates);
        await loadProducts();
        hideLoading();
        return { success: true };
      } catch (error) {
        hideLoading();
        return { success: false, error: error.message };
      }
    }

    async function deleteProduct(productId) {
      try {
        const currentStock = getCurrentStock(productId);
        if (currentStock > 0) {
          return { success: false, error: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏≠‡∏¢‡∏π‡πà‡πÑ‡∏î‡πâ' };
        }
        
        showLoading();
        await db.collection('products').doc(productId).delete();
        const movementsSnapshot = await db.collection('stockMovements')
          .where('productId', '==', productId).get();
        
        const batch = db.batch();
        movementsSnapshot.docs.forEach(doc => batch.delete(doc.ref));
        await batch.commit();
        
        await loadProducts();
        await loadStockMovements();
        hideLoading();
        return { success: true };
      } catch (error) {
        hideLoading();
        return { success: false, error: error.message };
      }
    }

    async function addStockMovement(movementData) {
      try {
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ö‡∏ß‡∏Å‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç
        if (movementData.quantity <= 0 || isNaN(movementData.quantity)) {
          return { success: false, error: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0' };
        }
        
        // ‡∏õ‡∏±‡∏î‡πÄ‡∏õ‡πá‡∏ô 2 ‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏°
        movementData.quantity = roundTo2Decimal(movementData.quantity);
        
        if (!movementData.ivNumber) {
          return { success: false, error: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà IV' };
        }
        
        if (movementData.type === 'receive') {
          const existingIV = stockMovements.find(m => 
            m.productId === movementData.productId && 
            m.ivNumber === movementData.ivNumber &&
            m.type === 'receive'
          );
          
          if (existingIV) {
            const confirmDuplicate = await showConfirmDialog(
              '‡∏û‡∏ö IV ‡∏ã‡πâ‡∏≥',
              `‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà IV "${movementData.ivNumber}" ‡πÄ‡∏Ñ‡∏¢‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`
            );
            
            if (!confirmDuplicate) {
              return { success: false, error: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å' };
            }
          }
        }
        
        showLoading();
        
        // ‡∏™‡∏£‡πâ‡∏≤‡∏á timestamp ‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
        let timestamp;
        if (movementData.customDate) {
          const dateObj = new Date(movementData.customDate);
          dateObj.setHours(new Date().getHours(), new Date().getMinutes(), new Date().getSeconds());
          timestamp = firebase.firestore.Timestamp.fromDate(dateObj);
        } else {
          timestamp = firebase.firestore.FieldValue.serverTimestamp();
        }
        
        const dataToSave = {
          type: movementData.type,
          productId: movementData.productId,
          quantity: movementData.quantity,
          ivNumber: movementData.ivNumber,
          timestamp: timestamp
        };
        
        if (movementData.poNumber) dataToSave.poNumber = movementData.poNumber;
        if (movementData.docNumber) dataToSave.docNumber = movementData.docNumber;
        
        await db.collection('stockMovements').add(dataToSave);
        await loadStockMovements();
        hideLoading();
        return { success: true };
      } catch (error) {
        hideLoading();
        return { success: false, error: error.message };
      }
    }

    // UI Helper Functions
    function showToast(message, type = 'success') {
      const config = window.elementSdk?.config || defaultConfig;
      const bgColor = type === 'success' ? 
        (config.success_color || defaultConfig.success_color) : 
        (config.danger_color || defaultConfig.danger_color);
      
      const toast = document.createElement('div');
      toast.className = 'fixed top-4 right-4 px-6 py-3 rounded-lg text-white shadow-lg z-50 fade-in';
      toast.style.backgroundColor = bgColor;
      toast.textContent = message;
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    function showModal(title, content, onConfirm) {
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 fade-in';
      modal.innerHTML = `
        <div class="card rounded-lg shadow-xl p-6 max-w-2xl w-full mx-4 max-h-[90%] overflow-auto">
          <h3 class="text-xl font-bold mb-4">${title}</h3>
          <div class="mb-6">${content}</div>
          <div class="flex justify-end gap-3">
            <button class="btn-cancel px-4 py-2 rounded-lg border" onclick="this.closest('.fixed').remove()">
              ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
            </button>
            <button class="btn-confirm btn-primary text-white px-4 py-2 rounded-lg">
              ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
            </button>
          </div>
        </div>
      `;
      
      modal.querySelector('.btn-confirm').onclick = () => {
        onConfirm();
        modal.remove();
      };
      
      document.body.appendChild(modal);
      applyConfigToUI(window.elementSdk?.config || defaultConfig);
    }

    function showConfirmDialog(title, message) {
      return new Promise((resolve) => {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 fade-in';
        modal.innerHTML = `
          <div class="card rounded-lg shadow-xl p-6 max-w-md w-full mx-4">
            <h3 class="text-xl font-bold mb-4">${title}</h3>
            <div class="mb-6">${message}</div>
            <div class="flex justify-end gap-3">
              <button class="btn-cancel px-4 py-2 rounded-lg border">
                ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
              </button>
              <button class="btn-confirm btn-primary text-white px-4 py-2 rounded-lg">
                ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
              </button>
            </div>
          </div>
        `;
        
        modal.querySelector('.btn-cancel').onclick = () => {
          modal.remove();
          resolve(false);
        };
        
        modal.querySelector('.btn-confirm').onclick = () => {
          modal.remove();
          resolve(true);
        };
        
        document.body.appendChild(modal);
        applyConfigToUI(window.elementSdk?.config || defaultConfig);
      });
    }

    // Render Functions
    function renderLoginPage() {
      return `
        <div class="h-full w-full flex items-center justify-center" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
          <div class="card rounded-lg shadow-2xl p-8 max-w-md w-full mx-4">
            <div class="text-center mb-8">
              <h1 id="app-title" class="text-3xl font-bold text-primary mb-2">${defaultConfig.app_title}</h1>
              <p id="company-name" class="text-gray-600">${defaultConfig.company_name}</p>
            </div>
            
            <form id="login-form" class="space-y-4">
              <div>
                <label for="email" class="block text-sm font-medium mb-1">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
                <input type="email" id="email" required
                  class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
              </div>
              
              <div>
                <label for="password" class="block text-sm font-medium mb-1">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
                <input type="password" id="password" required
                  class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
              </div>
              
              <button type="submit" class="btn-primary w-full text-white py-3 rounded-lg font-semibold hover:opacity-90 transition">
                ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
              </button>
            </form>
            
            <div id="login-error" class="mt-4 text-red-600 text-sm text-center hidden"></div>
          </div>
        </div>
      `;
    }

    function renderDashboard() {
      const config = window.elementSdk?.config || defaultConfig;
      const totalProducts = products.length;
      const totalStock = products.reduce((sum, p) => sum + getCurrentStock(p.id), 0);
      const lowStockItems = products.filter(p => getCurrentStock(p.id) < p.minStock).length;
      
      const receiveToday = stockMovements.filter(m => {
        if (m.type !== 'receive' || !m.timestamp) return false;
        const today = new Date();
        const movementDate = m.timestamp.toDate();
        return movementDate.toDateString() === today.toDateString();
      }).reduce((sum, m) => sum + m.quantity, 0);
      
      const issueToday = stockMovements.filter(m => {
        if (m.type !== 'issue' || !m.timestamp) return false;
        const today = new Date();
        const movementDate = m.timestamp.toDate();
        return movementDate.toDateString() === today.toDateString();
      }).reduce((sum, m) => sum + m.quantity, 0);
      
      return `
        <div class="space-y-6">
          <h2 class="text-2xl font-bold">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏£‡∏∞‡∏ö‡∏ö</h2>
          
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            <div class="card rounded-lg shadow p-6">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-gray-600 text-sm">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
                  <p class="text-3xl font-bold text-primary">${totalProducts}</p>
                  <p class="text-sm text-gray-500 mt-1">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>
                </div>
                <div class="text-4xl">üì¶</div>
              </div>
            </div>
            
            <div class="card rounded-lg shadow p-6">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-gray-600 text-sm">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏±‡∏á‡∏£‡∏ß‡∏°</p>
                  <p class="text-3xl font-bold text-primary">${formatNumber(totalStock)}</p>
                  <p class="text-sm text-gray-500 mt-1">‡∏´‡∏ô‡πà‡∏ß‡∏¢</p>
                </div>
                <div class="text-4xl">üìä</div>
              </div>
            </div>
            
            <div class="card rounded-lg shadow p-6">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-gray-600 text-sm">‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</p>
                  <p class="text-3xl font-bold" style="color: ${config.success_color || defaultConfig.success_color};">${formatNumber(receiveToday)}</p>
                  <p class="text-sm text-gray-500 mt-1">‡∏´‡∏ô‡πà‡∏ß‡∏¢</p>
                </div>
                <div class="text-4xl">üì•</div>
              </div>
            </div>
            
            <div class="card rounded-lg shadow p-6">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-gray-600 text-sm">‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</p>
                  <p class="text-3xl font-bold" style="color: ${config.danger_color || defaultConfig.danger_color};">${formatNumber(issueToday)}</p>
                  <p class="text-sm text-gray-500 mt-1">‡∏´‡∏ô‡πà‡∏ß‡∏¢</p>
                </div>
                <div class="text-4xl">üì§</div>
              </div>
            </div>
          </div>
          
          ${lowStockItems > 0 ? `
          <div class="card rounded-lg shadow p-6" style="border-left: 4px solid ${config.danger_color || defaultConfig.danger_color};">
            <div class="flex items-center gap-3 mb-4">
              <span class="text-3xl">‚ö†Ô∏è</span>
              <div>
                <h3 class="text-xl font-bold">‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ï‡πà‡∏≥</h3>
                <p class="text-sm text-gray-600">‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ï‡∏¥‡∏°‡∏™‡∏ï‡πá‡∏≠‡∏Å ${lowStockItems} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>
              </div>
            </div>
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead>
                  <tr class="border-b">
                    <th class="text-left py-3 px-4">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                    <th class="text-center py-3 px-4">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th>
                    <th class="text-center py-3 px-4">‡∏à‡∏∏‡∏î‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</th>
                    <th class="text-center py-3 px-4">‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ï‡∏¥‡∏°</th>
                    <th class="text-center py-3 px-4">‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</th>
                  </tr>
                </thead>
                <tbody>
                  ${products
                    .filter(p => getCurrentStock(p.id) < p.minStock)
                    .sort((a, b) => (getCurrentStock(a.id) - a.minStock) - (getCurrentStock(b.id) - b.minStock))
                    .map(p => {
                      const currentStock = getCurrentStock(p.id);
                      const shortage = roundTo2Decimal(p.minStock - currentStock);
                      return `
                        <tr class="border-b hover:bg-gray-50">
                          <td class="py-3 px-4 font-medium">${p.name}</td>
                          <td class="text-center py-3 px-4">
                            <span class="font-bold" style="color: ${config.danger_color || defaultConfig.danger_color};">${formatNumber(currentStock)}</span> ${p.unit}
                          </td>
                          <td class="text-center py-3 px-4">${formatNumber(p.minStock)} ${p.unit}</td>
                          <td class="text-center py-3 px-4">
                            <span class="px-3 py-1 rounded-full text-sm text-white" style="background-color: ${config.danger_color || defaultConfig.danger_color};">
                              +${formatNumber(shortage)} ${p.unit}
                            </span>
                          </td>
                          <td class="text-center py-3 px-4">
                            <button onclick="quickReceive('${p.id}', ${shortage})" 
                              class="text-sm px-3 py-1 rounded hover:opacity-80 text-white" 
                              style="background-color: ${config.success_color || defaultConfig.success_color};">
                              ‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏î‡πà‡∏ß‡∏ô
                            </button>
                          </td>
                        </tr>
                      `;
                    }).join('')}
                </tbody>
              </table>
            </div>
          </div>
          ` : `
          <div class="card rounded-lg shadow p-6 text-center" style="border-left: 4px solid ${config.success_color || defaultConfig.success_color};">
            <div class="text-5xl mb-3">‚úÖ</div>
            <h3 class="text-xl font-bold mb-2">‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏õ‡∏Å‡∏ï‡∏¥</h3>
            <p class="text-gray-600">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ï‡∏¥‡∏°‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ</p>
          </div>
          `}
          
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="card rounded-lg shadow p-6">
              <h3 class="text-lg font-bold mb-4">‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (5 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</h3>
              <div class="space-y-3">
                ${stockMovements
                  .filter(m => m.type === 'receive')
                  .slice(0, 5)
                  .map(m => {
                    const product = products.find(p => p.id === m.productId);
                    return `
                      <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <div class="flex-1">
                          <p class="font-medium">${product?.name || '-'}</p>
                        </div>
                        <div class="text-right">
                          <p class="font-bold" style="color: ${config.success_color || defaultConfig.success_color};">+${formatNumber(m.quantity)} ${product?.unit || ''}</p>
                          <p class="text-xs text-gray-500">IV: ${m.ivNumber}</p>
                        </div>
                      </div>
                    `;
                  }).join('') || '<p class="text-center text-gray-500 py-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>'}
              </div>
            </div>
            
            <div class="card rounded-lg shadow p-6">
              <h3 class="text-lg font-bold mb-4">‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (5 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</h3>
              <div class="space-y-3">
                ${stockMovements
                  .filter(m => m.type === 'issue')
                  .slice(0, 5)
                  .map(m => {
                    const product = products.find(p => p.id === m.productId);
                    return `
                      <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <div class="flex-1">
                          <p class="font-medium">${product?.name || '-'}</p>
                        </div>
                        <div class="text-right">
                          <p class="font-bold" style="color: ${config.danger_color || defaultConfig.danger_color};">-${formatNumber(m.quantity)} ${product?.unit || ''}</p>
                          <p class="text-xs text-gray-500">IV: ${m.ivNumber}</p>
                        </div>
                      </div>
                    `;
                  }).join('') || '<p class="text-center text-gray-500 py-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>'}
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function renderStockBalance() {
      return `
        <div class="space-y-6">
          <div class="flex justify-between items-center">
            <h2 class="text-2xl font-bold">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</h2>
            <input type="text" id="search-stock" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤..." 
              class="px-4 py-2 border rounded-lg w-64 focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>
          
          <div class="card rounded-lg shadow overflow-hidden">
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead class="bg-gray-50">
                  <tr>
                    <th class="text-left py-3 px-4 cursor-pointer hover:bg-gray-100" onclick="sortStockTable('name')">
                      ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‚Üï
                    </th>
                    <th class="text-center py-3 px-4">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏±‡∏ö</th>
                    <th class="text-center py-3 px-4 cursor-pointer hover:bg-gray-100" onclick="sortStockTable('stock')">
                      ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ‚Üï
                    </th>
                    <th class="text-center py-3 px-4">‡∏à‡∏∏‡∏î‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</th>
                    <th class="text-center py-3 px-4">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                  </tr>
                </thead>
                <tbody id="stock-table-body">
                  ${renderStockTableRows()}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      `;
    }

    function renderStockTableRows(searchTerm = '', sortBy = null) {
      let filteredProducts = [...products];
      
      if (searchTerm) {
        filteredProducts = filteredProducts.filter(p => 
          p.name.toLowerCase().includes(searchTerm.toLowerCase())
        );
      }
      
      if (sortBy === 'name') {
        filteredProducts.sort((a, b) => a.name.localeCompare(b.name, 'th'));
      } else if (sortBy === 'stock') {
        filteredProducts.sort((a, b) => getCurrentStock(a.id) - getCurrentStock(b.id));
      }
      
      return filteredProducts.map(p => {
        const stock = getCurrentStock(p.id);
        const isLow = stock < p.minStock;
        
        return `
          <tr class="border-b hover:bg-gray-50">
            <td class="py-3 px-4 font-medium">${p.name}</td>
            <td class="text-center py-3 px-4">${p.unit}</td>
            <td class="text-center py-3 px-4 font-bold">${formatNumber(stock)}</td>
            <td class="text-center py-3 px-4">${formatNumber(p.minStock)}</td>
            <td class="text-center py-3 px-4">
              <span class="px-3 py-1 rounded-full text-sm text-white" 
                style="background-color: ${isLow ? defaultConfig.danger_color : defaultConfig.success_color};">
                ${isLow ? '‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ï‡πà‡∏≥' : '‡∏õ‡∏Å‡∏ï‡∏¥'}
              </span>
            </td>
          </tr>
        `;
      }).join('') || '<tr><td colspan="5" class="text-center py-8 text-gray-500">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>';
    }

    function renderReceive() {
      // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
      const today = new Date().toISOString().split('T')[0];
      
      return `
        <div class="space-y-6">
          <h2 class="text-2xl font-bold">‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h2>
          
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="card rounded-lg shadow p-6">
              <h3 class="text-lg font-bold mb-4">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏ô‡πÄ‡∏≠‡∏á</h3>
              <form id="receive-form" class="space-y-4">
                <div>
                  <label class="block text-sm font-medium mb-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
                  <select id="receive-product" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ --</option>
                    ${products.map(p => `<option value="${p.id}" data-unit="${p.unit}">${p.name}</option>`).join('')}
                  </select>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <label class="block text-sm font-medium mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</label>
                    <input type="number" id="receive-quantity" min="0.01" step="0.01" required 
                      placeholder="100.50"
                      class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                  </div>
                  <div>
                    <label class="block text-sm font-medium mb-1">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏±‡∏ö</label>
                    <input type="text" id="receive-unit" readonly 
                      class="w-full px-4 py-2 border rounded-lg bg-gray-50">
                  </div>
                </div>
                
                <div>
                  <label class="block text-sm font-medium mb-1">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà PO</label>
                  <input type="text" id="receive-po" 
                    class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div>
                  <label class="block text-sm font-medium mb-1">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà IV <span class="text-red-500">*</span></label>
                  <input type="text" id="receive-iv" required 
                    class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div>
                  <label class="block text-sm font-medium mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤</label>
                  <input type="date" id="receive-date" value="${today}"
                    class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                
                <button type="submit" class="btn-success w-full text-white py-2 rounded-lg font-semibold hover:opacity-90">
                  ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤
                </button>
              </form>
            </div>
            
            <div class="card rounded-lg shadow p-6">
              <h3 class="text-lg font-bold mb-4">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î Excel</h3>
              <div class="space-y-4">
                <div class="border-2 border-dashed rounded-lg p-8 text-center">
                  <input type="file" id="receive-excel" accept=".xlsx,.xls" class="hidden">
                  <button onclick="document.getElementById('receive-excel').click()" 
                    class="btn-primary text-white px-6 py-2 rounded-lg hover:opacity-90">
                    üìÅ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel
                  </button>
                  <p class="text-sm text-gray-500 mt-2">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå .xlsx, .xls</p>
                  <p class="text-xs text-gray-400 mt-1">‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå: ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà, ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤, ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô, ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà PO, ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà IV</p>
                </div>
                
                <button onclick="downloadReceiveTemplate()" 
                  class="w-full border border-gray-300 py-2 rounded-lg hover:bg-gray-50">
                  üì• ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏°‡πà‡πÅ‡∏ö‡∏ö Excel
                </button>
              </div>
            </div>
          </div>
          
          <div class="card rounded-lg shadow p-6">
            <div class="flex justify-between items-center mb-4">
              <h3 class="text-lg font-bold">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h3>
              <button onclick="exportReceiveHistory()" 
                class="btn-primary text-white px-4 py-2 rounded-lg text-sm hover:opacity-90">
                üìä Export Excel
              </button>
            </div>
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead class="bg-gray-50">
                  <tr>
                    <th class="text-left py-3 px-4">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                    <th class="text-left py-3 px-4">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                    <th class="text-center py-3 px-4">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                    <th class="text-center py-3 px-4">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà PO</th>
                    <th class="text-center py-3 px-4">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà IV</th>
                    <th class="text-center py-3 px-4">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                  </tr>
                </thead>
                <tbody>
                  ${stockMovements
                    .filter(m => m.type === 'receive')
                    .slice(0, 10)
                    .map(m => {
                      const product = products.find(p => p.id === m.productId);
                      const dateStr = m.timestamp ? formatDateThai(m.timestamp.toDate().toISOString().split('T')[0]) : '-';
                      return `
                        <tr class="border-b hover:bg-gray-50">
                          <td class="py-3 px-4 text-sm">${dateStr}</td>
                          <td class="py-3 px-4">${product?.name || '-'}</td>
                          <td class="text-center py-3 px-4">${formatNumber(m.quantity)} ${product?.unit || ''}</td>
                          <td class="text-center py-3 px-4">${m.poNumber || '-'}</td>
                          <td class="text-center py-3 px-4 font-medium">${m.ivNumber}</td>
                          <td class="text-center py-3 px-4">
                            <button onclick="editStockMovement('${m.id}')" 
                              class="text-blue-600 hover:text-blue-800 mr-2" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç">
                              ‚úèÔ∏è
                            </button>
                            <button onclick="deleteStockMovement('${m.id}')" 
                              class="text-red-600 hover:text-red-800" title="‡∏•‡∏ö">
                              üóëÔ∏è
                            </button>
                          </td>
                        </tr>
                      `;
                    }).join('') || '<tr><td colspan="6" class="text-center py-8 text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</td></tr>'}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      `;
    }

    function renderIssue() {
      // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
      const today = new Date().toISOString().split('T')[0];
      
      return `
        <div class="space-y-6">
          <h2 class="text-2xl font-bold">‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h2>
          
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="card rounded-lg shadow p-6">
              <h3 class="text-lg font-bold mb-4">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏ô‡πÄ‡∏≠‡∏á</h3>
              <form id="issue-form" class="space-y-4">
                <div>
                  <label class="block text-sm font-medium mb-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
                  <select id="issue-product" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ --</option>
                    ${products.map(p => `<option value="${p.id}" data-unit="${p.unit}">${p.name}</option>`).join('')}
                  </select>
                </div>
                
                <div>
                  <label class="block text-sm font-medium mb-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà IV <span class="text-red-500">*</span></label>
                  <select id="issue-iv" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô --</option>
                  </select>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <label class="block text-sm font-medium mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</label>
                    <input type="number" id="issue-quantity" min="0.01" step="0.01" required 
                      placeholder="50.25"
                      class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                  </div>
                  <div>
                    <label class="block text-sm font-medium mb-1">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏±‡∏ö</label>
                    <input type="text" id="issue-unit" readonly 
                      class="w-full px-4 py-2 border rounded-lg bg-gray-50">
                  </div>
                </div>
                
                <div>
                  <label class="block text-sm font-medium mb-1">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å</label>
                  <input type="text" id="issue-doc" 
                    class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div>
                  <label class="block text-sm font-medium mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å</label>
                  <input type="date" id="issue-date" value="${today}"
                    class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div id="issue-warning" class="hidden p-3 rounded-lg text-sm" style="background-color: #fef2f2; color: #991b1b;">
                </div>
                
                <button type="submit" class="btn-danger w-full text-white py-2 rounded-lg font-semibold hover:opacity-90">
                  ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å
                </button>
              </form>
            </div>
            
            <div class="card rounded-lg shadow p-6">
              <h3 class="text-lg font-bold mb-4">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î Excel</h3>
              <div class="space-y-4">
                <div class="border-2 border-dashed rounded-lg p-8 text-center">
                  <input type="file" id="issue-excel" accept=".xlsx,.xls" class="hidden">
                  <button onclick="document.getElementById('issue-excel').click()" 
                    class="btn-primary text-white px-6 py-2 rounded-lg hover:opacity-90">
                    üìÅ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel
                  </button>
                  <p class="text-sm text-gray-500 mt-2">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå .xlsx, .xls</p>
                  <p class="text-xs text-gray-400 mt-1">‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå: ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà, ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤, ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô, ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà IV, ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</p>
                  <p class="text-xs text-red-500 mt-2">‚ö†Ô∏è ‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏∞‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° ‡πÑ‡∏°‡πà‡πÄ‡∏ä‡πá‡∏Ñ‡πÅ‡∏¢‡∏Å‡∏£‡∏≤‡∏¢ IV</p>
                </div>
                
                <button onclick="downloadIssueTemplate()" 
                  class="w-full border border-gray-300 py-2 rounded-lg hover:bg-gray-50">
                  üì• ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏°‡πà‡πÅ‡∏ö‡∏ö Excel
                </button>
              </div>
            </div>
          </div>
          
          <div class="card rounded-lg shadow p-6">
            <div class="flex justify-between items-center mb-4">
              <h3 class="text-lg font-bold">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h3>
              <button onclick="exportIssueHistory()" 
                class="btn-primary text-white px-4 py-2 rounded-lg text-sm hover:opacity-90">
                üìä Export Excel
              </button>
            </div>
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead class="bg-gray-50">
                  <tr>
                    <th class="text-left py-3 px-4">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                    <th class="text-left py-3 px-4">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                    <th class="text-center py-3 px-4">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                    <th class="text-center py-3 px-4">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà IV</th>
                    <th class="text-center py-3 px-4">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</th>
                    <th class="text-center py-3 px-4">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                  </tr>
                </thead>
                <tbody>
                  ${stockMovements
                    .filter(m => m.type === 'issue')
                    .slice(0, 10)
                    .map(m => {
                      const product = products.find(p => p.id === m.productId);
                      const dateStr = m.timestamp ? formatDateThai(m.timestamp.toDate().toISOString().split('T')[0]) : '-';
                      return `
                        <tr class="border-b hover:bg-gray-50">
                          <td class="py-3 px-4 text-sm">${dateStr}</td>
                          <td class="py-3 px-4">${product?.name || '-'}</td>
                          <td class="text-center py-3 px-4">${formatNumber(m.quantity)} ${product?.unit || ''}</td>
                          <td class="text-center py-3 px-4 font-medium">${m.ivNumber}</td>
                          <td class="text-center py-3 px-4">${m.docNumber || '-'}</td>
                          <td class="text-center py-3 px-4">
                            <button onclick="editStockMovement('${m.id}')" 
                              class="text-blue-600 hover:text-blue-800 mr-2" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç">
                              ‚úèÔ∏è
                            </button>
                            <button onclick="deleteStockMovement('${m.id}')" 
                              class="text-red-600 hover:text-red-800" title="‡∏•‡∏ö">
                              üóëÔ∏è
                            </button>
                          </td>
                        </tr>
                      `;
                    }).join('') || '<tr><td colspan="6" class="text-center py-8 text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</td></tr>'}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      `;
    }

    function renderStockByIV() {
      return `
        <div class="space-y-6">
          <h2 class="text-2xl font-bold">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÅ‡∏¢‡∏Å IV</h2>
          
          <div class="card rounded-lg shadow p-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
              <div>
                <label class="block text-sm font-medium mb-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
                <select id="stock-iv-product" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                  <option value="">-- ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î --</option>
                  ${products.map(p => `<option value="${p.id}">${p.name}</option>`).join('')}
                </select>
              </div>
              
              <div>
                <label class="block text-sm font-medium mb-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å IV</label>
                <select id="stock-iv-number" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                  <option value="">-- ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î --</option>
                </select>
              </div>
            </div>
            
            <div id="stock-iv-results" class="space-y-4">
              ${renderStockByIVCards()}
            </div>
          </div>
        </div>
      `;
    }

    function renderStockByIVCards(selectedProductId = '', selectedIV = '') {
      let results = [];
      
      Object.keys(productStockByIV).forEach(productId => {
        if (selectedProductId && productId !== selectedProductId) return;
        
        const product = products.find(p => p.id === productId);
        if (!product) return;
        
        const ivStock = productStockByIV[productId];
        Object.entries(ivStock).forEach(([iv, qty]) => {
          if (qty > 0) {
            if (selectedIV && iv !== selectedIV) return;
            results.push({ product, iv, qty });
          }
        });
      });
      
      if (results.length === 0) {
        return '<p class="text-center text-gray-500 py-8">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>';
      }
      
      const groupedByProduct = {};
      results.forEach(item => {
        if (!groupedByProduct[item.product.id]) {
          groupedByProduct[item.product.id] = {
            product: item.product,
            ivs: []
          };
        }
        groupedByProduct[item.product.id].ivs.push({ iv: item.iv, qty: item.qty });
      });
      
      return Object.values(groupedByProduct).map(group => `
        <div class="border rounded-lg p-4">
          <h4 class="font-bold text-lg mb-3">${group.product.name}</h4>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
            ${group.ivs.map(ivData => `
              <div class="bg-gray-50 rounded p-3">
                <div class="text-sm text-gray-600">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà IV</div>
                <div class="font-bold text-primary">${ivData.iv}</div>
                <div class="text-sm mt-1">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: <span class="font-semibold">${formatNumber(ivData.qty)} ${group.product.unit}</span></div>
              </div>
            `).join('')}
          </div>
        </div>
      `).join('');
    }

    function renderItemMovement() {
      return `
        <div class="space-y-6">
          <h2 class="text-2xl font-bold">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h2>
          
          <div class="card rounded-lg shadow p-6">
            <div class="mb-6">
              <label class="block text-sm font-medium mb-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
              <select id="movement-product" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ --</option>
                ${products.map(p => `<option value="${p.id}">${p.name}</option>`).join('')}
              </select>
            </div>
            
            <div id="movement-results"></div>
          </div>
        </div>
      `;
    }

    function renderMovementResults(productId) {
      const product = products.find(p => p.id === productId);
      if (!product) return '<p class="text-center text-gray-500 py-8">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</p>';
      
      const movements = stockMovements.filter(m => m.productId === productId);
      const currentStock = getCurrentStock(productId);
      
      return `
        <div class="space-y-4">
          <div class="bg-blue-50 rounded-lg p-4">
            <div class="text-sm text-gray-600">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤: <span class="font-bold">${product.name}</span></div>
            <div class="text-2xl font-bold text-primary mt-1">${formatNumber(currentStock)} ${product.unit}</div>
            <div class="text-sm text-gray-600">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</div>
          </div>
          
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead class="bg-gray-50">
                <tr>
                  <th class="text-left py-3 px-4">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà/‡πÄ‡∏ß‡∏•‡∏≤</th>
                  <th class="text-center py-3 px-4">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
                  <th class="text-center py-3 px-4">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                  <th class="text-center py-3 px-4">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà IV</th>
                  <th class="text-center py-3 px-4">‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á</th>
                </tr>
              </thead>
              <tbody>
                ${movements.map(m => {
                  const dateStr = formatDateTimeThai(m.timestamp);
                  const isReceive = m.type === 'receive';
                  return `
                    <tr class="border-b hover:bg-gray-50">
                      <td class="py-3 px-4">${dateStr}</td>
                      <td class="text-center py-3 px-4">
                        <span class="px-3 py-1 rounded-full text-sm text-white" 
                          style="background-color: ${isReceive ? defaultConfig.success_color : defaultConfig.danger_color};">
                          ${isReceive ? 'üì• ‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤' : 'üì§ ‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å'}
                        </span>
                      </td>
                      <td class="text-center py-3 px-4 font-bold">
                        ${isReceive ? '+' : '-'}${formatNumber(m.quantity)} ${product.unit}
                      </td>
                      <td class="text-center py-3 px-4 font-medium">${m.ivNumber}</td>
                      <td class="text-center py-3 px-4">${m.poNumber || m.docNumber || '-'}</td>
                    </tr>
                  `;
                }).join('') || '<tr><td colspan="5" class="text-center py-8 text-gray-500">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß</td></tr>'}
              </tbody>
            </table>
          </div>
        </div>
      `;
    }

    function renderMasterData() {
      return `
        <div class="space-y-6">
          <h2 class="text-2xl font-bold">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h2>
          
          <div class="card rounded-lg shadow p-6">
            <h3 class="text-lg font-bold mb-4">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà</h3>
            <form id="product-form" class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div>
                <label class="block text-sm font-medium mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ <span class="text-red-500">*</span></label>
                <input type="text" id="product-name" required 
                  class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
              </div>
              
              <div>
                <label class="block text-sm font-medium mb-1">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏±‡∏ö <span class="text-red-500">*</span></label>
                <input type="text" id="product-unit" required 
                  class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
              </div>
              
              <div>
                <label class="block text-sm font-medium mb-1">‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ <span class="text-red-500">*</span></label>
                <input type="number" id="product-min" min="0" step="0.01" required 
                  placeholder="10.00"
                  class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
              </div>
              
              <button type="submit" class="btn-success text-white px-6 py-2 rounded-lg font-semibold hover:opacity-90 md:col-span-3">
                ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
              </button>
            </form>
          </div>
          
          <div class="card rounded-lg shadow p-6">
            <div class="flex justify-between items-center mb-4">
              <h3 class="text-lg font-bold">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
              <div class="flex gap-2">
                <button onclick="importProductsExcel()" 
                  class="btn-primary text-white px-4 py-2 rounded-lg text-sm hover:opacity-90">
                  üìÅ Import Excel
                </button>
                <button onclick="exportProductsExcel()" 
                  class="btn-primary text-white px-4 py-2 rounded-lg text-sm hover:opacity-90">
                  üìä Export Excel
                </button>
              </div>
            </div>
            
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead class="bg-gray-50">
                  <tr>
                    <th class="text-left py-3 px-4">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                    <th class="text-center py-3 px-4">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏±‡∏ö</th>
                    <th class="text-center py-3 px-4">‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥</th>
                    <th class="text-center py-3 px-4">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</th>
                    <th class="text-center py-3 px-4">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                  </tr>
                </thead>
                <tbody>
                  ${products.map(p => `
                    <tr class="border-b hover:bg-gray-50">
                      <td class="py-3 px-4 font-medium">${p.name}</td>
                      <td class="text-center py-3 px-4">${p.unit}</td>
                      <td class="text-center py-3 px-4">
                        <input type="number" value="${p.minStock}" step="0.01"
                          onchange="updateMinStock('${p.id}', this.value)"
                          class="w-24 px-2 py-1 border rounded text-center focus:outline-none focus:ring-2 focus:ring-blue-500">
                      </td>
                      <td class="text-center py-3 px-4 font-bold">${formatNumber(getCurrentStock(p.id))}</td>
                      <td class="text-center py-3 px-4">
                        <button onclick="confirmDeleteProduct('${p.id}', '${p.name}')" 
                          class="text-red-600 hover:text-red-800 font-medium">
                          üóëÔ∏è ‡∏•‡∏ö
                        </button>
                      </td>
                    </tr>
                  `).join('') || '<tr><td colspan="5" class="text-center py-8 text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</td></tr>'}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      `;
    }

    function renderMainApp() {
      const config = window.elementSdk?.config || defaultConfig;
      
      return `
        <div class="h-full w-full flex flex-col">
          <nav class="bg-primary text-white shadow-lg">
            <div class="px-4 py-3">
              <div class="flex justify-between items-center">
                <div>
                  <h1 id="app-title" class="text-xl font-bold">${config.app_title || defaultConfig.app_title}</h1>
                  <p id="company-name" class="text-sm opacity-90">${config.company_name || defaultConfig.company_name}</p>
                </div>
                <div class="flex items-center gap-4">
                  <span class="text-sm">üë§ ${currentUser.email}</span>
                  <button onclick="handleLogout()" 
                    class="px-4 py-2 bg-white bg-opacity-20 rounded-lg hover:bg-opacity-30 transition text-sm">
                    ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
                  </button>
                </div>
              </div>
            </div>
            
            <div class="px-4 overflow-x-auto">
              <div class="flex gap-2 pb-2 min-w-max">
                ${[
                  { id: 'dashboard', label: 'üìä ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°', icon: 'üìä' },
                  { id: 'stock', label: 'üì¶ ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠', icon: 'üì¶' },
                  { id: 'receive', label: 'üì• ‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤', icon: 'üì•' },
                  { id: 'issue', label: 'üì§ ‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å', icon: 'üì§' },
                  { id: 'stockByIV', label: 'üìã ‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÅ‡∏¢‡∏Å IV', icon: 'üìã' },
                  { id: 'movement', label: 'üìà ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß', icon: 'üìà' },
                  { id: 'master', label: '‚öôÔ∏è ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', icon: '‚öôÔ∏è' }
                ].map(menu => `
                  <button onclick="switchMenu('${menu.id}')" 
                    class="px-4 py-2 rounded-t-lg transition whitespace-nowrap ${
                      currentMenu === menu.id 
                        ? 'bg-white text-gray-900 font-semibold' 
                        : 'text-white hover:bg-white hover:bg-opacity-20'
                    }">
                    ${menu.label}
                  </button>
                `).join('')}
              </div>
            </div>
          </nav>
          
          <main class="flex-1 overflow-auto p-6">
            <div id="main-content" class="max-w-7xl mx-auto">
              ${renderCurrentMenu()}
            </div>
          </main>
        </div>
      `;
    }

    function renderCurrentMenu() {
      switch (currentMenu) {
        case 'dashboard': return renderDashboard();
        case 'stock': return renderStockBalance();
        case 'receive': return renderReceive();
        case 'issue': return renderIssue();
        case 'stockByIV': return renderStockByIV();
        case 'movement': return renderItemMovement();
        case 'master': return renderMasterData();
        default: return renderDashboard();
      }
    }

    function renderApp() {
      const appDiv = document.getElementById('app');
      
      if (!currentUser) {
        appDiv.innerHTML = renderLoginPage();
        setupLoginHandlers();
      } else {
        appDiv.innerHTML = renderMainApp();
        setupAppHandlers();
      }
      
      applyConfigToUI(window.elementSdk?.config || defaultConfig);
    }

    // Event Handlers
    function setupLoginHandlers() {
      const form = document.getElementById('login-form');
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const errorDiv = document.getElementById('login-error');
        
        const result = await handleLogin(email, password);
        
        if (!result.success) {
          errorDiv.textContent = '‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
          errorDiv.classList.remove('hidden');
        }
      });
    }

    function setupAppHandlers() {
      if (currentMenu === 'stock') {
        const searchInput = document.getElementById('search-stock');
        if (searchInput) {
          searchInput.addEventListener('input', (e) => {
            const tbody = document.getElementById('stock-table-body');
            tbody.innerHTML = renderStockTableRows(e.target.value);
          });
        }
      }
      
      if (currentMenu === 'receive') {
        const form = document.getElementById('receive-form');
        const productSelect = document.getElementById('receive-product');
        const unitInput = document.getElementById('receive-unit');
        
        productSelect.addEventListener('change', (e) => {
          const option = e.target.selectedOptions[0];
          unitInput.value = option.dataset.unit || '';
        });
        
        form.addEventListener('submit', async (e) => {
          e.preventDefault();
          
          const productId = document.getElementById('receive-product').value;
          const quantity = parseFloat(document.getElementById('receive-quantity').value);
          const poNumber = document.getElementById('receive-po').value;
          const ivNumber = document.getElementById('receive-iv').value;
          const customDate = document.getElementById('receive-date').value;
          
          const product = products.find(p => p.id === productId);
          
          const dateDisplay = convertInputDateToDisplay(customDate);
          
          const content = `
            <div class="space-y-2">
              <p><strong>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤:</strong> ${product.name}</p>
              <p><strong>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô:</strong> ${formatNumber(quantity)} ${product.unit}</p>
              <p><strong>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà PO:</strong> ${poNumber || '-'}</p>
              <p><strong>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà IV:</strong> ${ivNumber}</p>
              <p><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</strong> ${dateDisplay}</p>
            </div>
          `;
          
          showModal('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', content, async () => {
            const result = await addStockMovement({
              type: 'receive',
              productId,
              quantity,
              poNumber,
              ivNumber,
              customDate
            });
            
            if (result.success) {
              showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
              form.reset();
              // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
              document.getElementById('receive-date').value = new Date().toISOString().split('T')[0];
              renderApp();
            } else {
              showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + result.error, 'error');
            }
          });
        });
        
        const excelInput = document.getElementById('receive-excel');
        excelInput.addEventListener('change', handleReceiveExcelUpload);
      }
      
      if (currentMenu === 'issue') {
        const form = document.getElementById('issue-form');
        const productSelect = document.getElementById('issue-product');
        const ivSelect = document.getElementById('issue-iv');
        const unitInput = document.getElementById('issue-unit');
        const quantityInput = document.getElementById('issue-quantity');
        const warningDiv = document.getElementById('issue-warning');
        
        productSelect.addEventListener('change', (e) => {
          const option = e.target.selectedOptions[0];
          unitInput.value = option.dataset.unit || '';
          
          const productId = e.target.value;
          const availableIVs = getAvailableIVs(productId);
          
          ivSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà IV --</option>' +
            availableIVs.map(iv => 
              `<option value="${iv.iv}" data-qty="${iv.qty}">${iv.iv} (‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${formatNumber(iv.qty)})</option>`
            ).join('');
          
          warningDiv.classList.add('hidden');
        });
        
        ivSelect.addEventListener('change', () => {
          warningDiv.classList.add('hidden');
        });
        
        quantityInput.addEventListener('input', () => {
          const selectedIV = ivSelect.selectedOptions[0];
          if (selectedIV && selectedIV.dataset.qty) {
            const maxQty = parseFloat(selectedIV.dataset.qty);
            const currentQty = parseFloat(quantityInput.value) || 0;
            
            if (currentQty > maxQty) {
              warningDiv.textContent = `‚ö†Ô∏è ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏ (${formatNumber(currentQty)}) ‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÉ‡∏ô IV ‡∏ô‡∏µ‡πâ (${formatNumber(maxQty)})`;
              warningDiv.classList.remove('hidden');
            } else {
              warningDiv.classList.add('hidden');
            }
          }
        });
        
        form.addEventListener('submit', async (e) => {
          e.preventDefault();
          
          const productId = document.getElementById('issue-product').value;
          const ivNumber = document.getElementById('issue-iv').value;
          const quantity = parseFloat(document.getElementById('issue-quantity').value);
          const docNumber = document.getElementById('issue-doc').value;
          const customDate = document.getElementById('issue-date').value;
          
          const selectedIV = ivSelect.selectedOptions[0];
          const maxQty = parseFloat(selectedIV.dataset.qty);
          
          if (quantity > maxQty) {
            showToast(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ö‡∏¥‡∏Å‡πÄ‡∏Å‡∏¥‡∏ô ${formatNumber(maxQty)} ‡∏à‡∏≤‡∏Å IV ‡∏ô‡∏µ‡πâ`, 'error');
            return;
          }
          
          const product = products.find(p => p.id === productId);
          
          const dateDisplay = convertInputDateToDisplay(customDate);
          
          const content = `
            <div class="space-y-2">
              <p><strong>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤:</strong> ${product.name}</p>
              <p><strong>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô:</strong> ${formatNumber(quantity)} ${product.unit}</p>
              <p><strong>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà IV:</strong> ${ivNumber}</p>
              <p><strong>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£:</strong> ${docNumber || '-'}</p>
              <p><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</strong> ${dateDisplay}</p>
            </div>
          `;
          
          showModal('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', content, async () => {
            const result = await addStockMovement({
              type: 'issue',
              productId,
              quantity,
              ivNumber,
              docNumber,
              customDate
            });
            
            if (result.success) {
              showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
              form.reset();
              // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
              document.getElementById('issue-date').value = new Date().toISOString().split('T')[0];
              renderApp();
            } else {
              showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + result.error, 'error');
            }
          });
        });
        
        const excelInput = document.getElementById('issue-excel');
        excelInput.addEventListener('change', handleIssueExcelUpload);
      }
      
      if (currentMenu === 'stockByIV') {
        const productSelect = document.getElementById('stock-iv-product');
        const ivSelect = document.getElementById('stock-iv-number');
        
        productSelect.addEventListener('change', (e) => {
          const productId = e.target.value;
          
          if (productId) {
            const ivStock = productStockByIV[productId] || {};
            const ivs = Object.entries(ivStock)
              .filter(([iv, qty]) => qty > 0)
              .map(([iv]) => iv);
            
            ivSelect.innerHTML = '<option value="">-- ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î --</option>' +
              ivs.map(iv => `<option value="${iv}">${iv}</option>`).join('');
          } else {
            ivSelect.innerHTML = '<option value="">-- ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î --</option>';
          }
          
          updateStockByIVResults();
        });
        
        ivSelect.addEventListener('change', updateStockByIVResults);
      }
      
      if (currentMenu === 'movement') {
        const productSelect = document.getElementById('movement-product');
        
        productSelect.addEventListener('change', (e) => {
          const resultsDiv = document.getElementById('movement-results');
          resultsDiv.innerHTML = renderMovementResults(e.target.value);
        });
      }
      
      if (currentMenu === 'master') {
        const form = document.getElementById('product-form');
        
        form.addEventListener('submit', async (e) => {
          e.preventDefault();
          
          const name = document.getElementById('product-name').value;
          const unit = document.getElementById('product-unit').value;
          const minStock = parseFloat(document.getElementById('product-min').value);
          
          const result = await addProduct({ name, unit, minStock });
          
          if (result.success) {
            showToast('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
            form.reset();
            renderApp();
          } else {
            showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + result.error, 'error');
          }
        });
      }
    }

    async function handleReceiveExcelUpload(e) {
      const file = e.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = async (event) => {
        try {
          const data = new Uint8Array(event.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          const sheet = workbook.Sheets[workbook.SheetNames[0]];
          const rows = XLSX.utils.sheet_to_json(sheet);
          
          const movements = [];
          const warnings = [];
          
          for (const row of rows) {
            const dateValue = row['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà'];
            const productName = row['‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'];
            const quantity = parseFloat(row['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô']);
            const poNumber = row['‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà PO'] || '';
            const ivNumber = row['‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà IV'];
            
            const product = products.find(p => p.name === productName);
            if (product && quantity > 0 && !isNaN(quantity) && ivNumber) {
              const existingIV = stockMovements.find(m => 
                m.productId === product.id && 
                m.ivNumber === ivNumber &&
                m.type === 'receive'
              );
              
              if (existingIV) {
                warnings.push(`${productName} - IV ${ivNumber} ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß`);
              }
              
              // ‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≤‡∏Å Excel ‡∏î‡πâ‡∏ß‡∏¢ UTC
              let customDate = null;
              if (dateValue) {
                if (typeof dateValue === 'number') {
                  // Excel date serial number - ‡πÉ‡∏ä‡πâ UTC
                  customDate = excelDateToYMD(dateValue);
                } else if (typeof dateValue === 'string') {
                  // String format (YYYY-MM-DD or DD/MM/YYYY)
                  const dateStr = dateValue.trim();
                  if (dateStr.match(/^\d{4}-\d{2}-\d{2}$/)) {
                    customDate = dateStr;
                  } else if (dateStr.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
                    const [day, month, year] = dateStr.split('/');
                    customDate = `${year}-${month}-${day}`;
                  }
                }
              }
              
              movements.push({
                type: 'receive',
                productId: product.id,
                quantity: roundTo2Decimal(quantity),
                poNumber,
                ivNumber,
                customDate
              });
            }
          }
          
          if (movements.length === 0) {
            showToast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
            return;
          }
          
          const content = `
            <div class="space-y-2">
              <p>‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• <strong>${movements.length}</strong> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>
              ${warnings.length > 0 ? `
                <div class="bg-yellow-50 border border-yellow-200 rounded p-3 text-sm">
                  <p class="font-bold text-yellow-800 mb-2">‚ö†Ô∏è ‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô IV ‡∏ã‡πâ‡∏≥:</p>
                  ${warnings.slice(0, 5).map(w => `<p class="text-yellow-700">‚Ä¢ ${w}</p>`).join('')}
                  ${warnings.length > 5 ? `<p class="text-yellow-700 mt-1">... ‡πÅ‡∏•‡∏∞‡∏≠‡∏µ‡∏Å ${warnings.length - 5} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>` : ''}
                </div>
              ` : ''}
              <div class="max-h-64 overflow-auto border rounded p-2">
                ${movements.map(m => {
                  const p = products.find(pr => pr.id === m.productId);
                  const dateDisplay = m.customDate ? formatDateThai(m.customDate) : '‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ';
                  return `<div class="text-sm">${p.name}: ${formatNumber(m.quantity)} ${p.unit} (IV: ${m.ivNumber}, ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${dateDisplay})</div>`;
                }).join('')}
              </div>
            </div>
          `;
          
          showModal('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', content, async () => {
            for (const movement of movements) {
              await addStockMovement(movement);
            }
            showToast(`‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${movements.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`, 'success');
            renderApp();
          });
          
        } catch (error) {
          showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå', 'error');
        }
      };
      reader.readAsArrayBuffer(file);
      e.target.value = '';
    }

    async function handleIssueExcelUpload(e) {
      const file = e.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = async (event) => {
        try {
          const data = new Uint8Array(event.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          const sheet = workbook.Sheets[workbook.SheetNames[0]];
          const rows = XLSX.utils.sheet_to_json(sheet);
          
          const movements = [];
          for (const row of rows) {
            const dateValue = row['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà'];
            const productName = row['‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'];
            const quantity = parseFloat(row['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô']);
            const ivNumber = row['‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà IV'];
            const docNumber = row['‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£'] || '';
            
            const product = products.find(p => p.name === productName);
            if (product && quantity > 0 && !isNaN(quantity) && ivNumber) {
              const currentStock = getCurrentStock(product.id);
              if (quantity <= currentStock) {
                // ‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≤‡∏Å Excel ‡∏î‡πâ‡∏ß‡∏¢ UTC
                let customDate = null;
                if (dateValue) {
                  if (typeof dateValue === 'number') {
                    // Excel date serial number - ‡πÉ‡∏ä‡πâ UTC
                    customDate = excelDateToYMD(dateValue);
                  } else if (typeof dateValue === 'string') {
                    // String format (YYYY-MM-DD or DD/MM/YYYY)
                    const dateStr = dateValue.trim();
                    if (dateStr.match(/^\d{4}-\d{2}-\d{2}$/)) {
                      customDate = dateStr;
                    } else if (dateStr.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
                      const [day, month, year] = dateStr.split('/');
                      customDate = `${year}-${month}-${day}`;
                    }
                  }
                }
                
                movements.push({
                  type: 'issue',
                  productId: product.id,
                  quantity: roundTo2Decimal(quantity),
                  ivNumber,
                  docNumber,
                  customDate
                });
              }
            }
          }
          
          if (movements.length === 0) {
            showToast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠', 'error');
            return;
          }
          
          const content = `
            <div class="space-y-2">
              <p>‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• <strong>${movements.length}</strong> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>
              <p class="text-sm text-yellow-700 bg-yellow-50 p-2 rounded">‚ö†Ô∏è ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏ö‡∏ö Excel ‡∏à‡∏∞‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏™‡∏ï‡πá‡∏≠‡∏Å ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡πá‡∏Ñ‡πÅ‡∏¢‡∏Å‡∏£‡∏≤‡∏¢ IV</p>
              <div class="max-h-64 overflow-auto border rounded p-2">
                ${movements.map(m => {
                  const p = products.find(pr => pr.id === m.productId);
                  const dateDisplay = m.customDate ? formatDateThai(m.customDate) : '‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ';
                  return `<div class="text-sm">${p.name}: ${formatNumber(m.quantity)} ${p.unit} (IV: ${m.ivNumber}, ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${dateDisplay})</div>`;
                }).join('')}
              </div>
            </div>
          `;
          
          showModal('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', content, async () => {
            for (const movement of movements) {
              await addStockMovement(movement);
            }
            showToast(`‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${movements.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`, 'success');
            renderApp();
          });
          
        } catch (error) {
          showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå', 'error');
        }
      };
      reader.readAsArrayBuffer(file);
      e.target.value = '';
    }

    // Global Functions
    window.switchMenu = (menu) => {
      currentMenu = menu;
      renderApp();
    };

    window.sortStockTable = (sortBy) => {
      const tbody = document.getElementById('stock-table-body');
      const searchInput = document.getElementById('search-stock');
      tbody.innerHTML = renderStockTableRows(searchInput.value, sortBy);
    };

    window.updateStockByIVResults = () => {
      const productId = document.getElementById('stock-iv-product').value;
      const ivNumber = document.getElementById('stock-iv-number').value;
      const resultsDiv = document.getElementById('stock-iv-results');
      resultsDiv.innerHTML = renderStockByIVCards(productId, ivNumber);
    };

    window.updateMinStock = async (productId, newValue) => {
      const result = await updateProduct(productId, { minStock: parseFloat(newValue) });
      if (result.success) {
        showToast('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
      } else {
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error');
      }
    };

    window.confirmDeleteProduct = async (productId, productName) => {
      const currentStock = getCurrentStock(productId);
      
      const content = `
        <p class="text-red-600 font-semibold">‚ö†Ô∏è ‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</p>
        <p class="mt-2">‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ "<strong>${productName}</strong>" ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</p>
        ${currentStock > 0 ? 
          `<p class="text-sm text-red-600 mt-2 bg-red-50 p-2 rounded">‚ùå ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡∏°‡∏µ‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${formatNumber(currentStock)} ‡∏´‡∏ô‡πà‡∏ß‡∏¢ ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡πÑ‡∏î‡πâ</p>` :
          `<p class="text-sm text-gray-600 mt-2">‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏∞‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏î‡πâ‡∏ß‡∏¢</p>`
        }
      `;
      
      showModal('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', content, async () => {
        if (currentStock > 0) {
          showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÑ‡∏î‡πâ', 'error');
          return;
        }
        
        const result = await deleteProduct(productId);
        if (result.success) {
          showToast('‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
          renderApp();
        } else {
          showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + result.error, 'error');
        }
      });
    };

    window.downloadReceiveTemplate = () => {
      const template = [
        { '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà': '2024-01-15', '‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤': '‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô': 100.50, '‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà PO': 'PO001', '‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà IV': 'IV001' }
      ];
      const ws = XLSX.utils.json_to_sheet(template);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Template');
      XLSX.writeFile(wb, 'template_receive.xlsx');
    };

    window.downloadIssueTemplate = () => {
      const template = [
        { '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà': '2024-01-15', '‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤': '‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô': 50.25, '‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà IV': 'IV001', '‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£': 'DOC001' }
      ];
      const ws = XLSX.utils.json_to_sheet(template);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Template');
      XLSX.writeFile(wb, 'template_issue.xlsx');
    };

    window.exportReceiveHistory = () => {
      const data = stockMovements
        .filter(m => m.type === 'receive')
        .map(m => {
          const product = products.find(p => p.id === m.productId);
          const dateStr = formatDateThai(m.timestamp ? m.timestamp.toDate().toISOString().split('T')[0] : '');
          return {
            '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà': dateStr,
            '‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤': product?.name || '-',
            '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô': m.quantity,
            '‡∏´‡∏ô‡πà‡∏ß‡∏¢': product?.unit || '',
            '‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà PO': m.poNumber || '-',
            '‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà IV': m.ivNumber
          };
        });
      
      const ws = XLSX.utils.json_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, '‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤');
      XLSX.writeFile(wb, 'receive_history.xlsx');
    };

    window.exportIssueHistory = () => {
      const data = stockMovements
        .filter(m => m.type === 'issue')
        .map(m => {
          const product = products.find(p => p.id === m.productId);
          const dateStr = formatDateThai(m.timestamp ? m.timestamp.toDate().toISOString().split('T')[0] : '');
          return {
            '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà': dateStr,
            '‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤': product?.name || '-',
            '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô': m.quantity,
            '‡∏´‡∏ô‡πà‡∏ß‡∏¢': product?.unit || '',
            '‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà IV': m.ivNumber,
            '‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£': m.docNumber || '-'
          };
        });
      
      const ws = XLSX.utils.json_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, '‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å');
      XLSX.writeFile(wb, 'issue_history.xlsx');
    };

    window.importProductsExcel = () => {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.xlsx,.xls';
      input.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = async (event) => {
          try {
            const data = new Uint8Array(event.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            const rows = XLSX.utils.sheet_to_json(sheet);
            
            const newProducts = [];
            for (const row of rows) {
              const name = row['‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'];
              const unit = row['‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏±‡∏ö'];
              const minStock = parseFloat(row['‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥']) || 0;
              
              if (name && unit) {
                newProducts.push({ name, unit, minStock: roundTo2Decimal(minStock) });
              }
            }
            
            if (newProducts.length === 0) {
              showToast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
              return;
            }
            
            const content = `
              <div class="space-y-2">
                <p>‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• <strong>${newProducts.length}</strong> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>
                <div class="max-h-64 overflow-auto border rounded p-2">
                  ${newProducts.map(p => `<div class="text-sm">${p.name} (${p.unit})</div>`).join('')}
                </div>
              </div>
            `;
            
            showModal('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', content, async () => {
              for (const product of newProducts) {
                await addProduct(product);
              }
              showToast(`‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ${newProducts.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`, 'success');
              renderApp();
            });
            
          } catch (error) {
            showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå', 'error');
          }
        };
        reader.readAsArrayBuffer(file);
      };
      input.click();
    };

    window.exportProductsExcel = () => {
      const data = products.map(p => ({
        '‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤': p.name,
        '‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏±‡∏ö': p.unit,
        '‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥': p.minStock,
        '‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô': getCurrentStock(p.id)
      }));
      
      const ws = XLSX.utils.json_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, '‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤');
      XLSX.writeFile(wb, 'products.xlsx');
    };

    window.quickReceive = (productId, suggestedQty) => {
      const product = products.find(p => p.id === productId);
      if (!product) return;
      
      const content = `
        <div class="space-y-4">
          <div class="bg-gray-50 p-4 rounded-lg">
            <p class="font-bold text-lg">${product.name}</p>
            <p class="text-sm text-gray-600 mt-1">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏±‡∏ö: ${product.unit}</p>
            <p class="text-sm text-gray-600">‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: ${formatNumber(getCurrentStock(productId))} ${product.unit}</p>
            <p class="text-sm text-gray-600">‡∏à‡∏∏‡∏î‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠: ${formatNumber(product.minStock)} ${product.unit}</p>
          </div>
          
          <div>
            <label class="block text-sm font-medium mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤ <span class="text-red-500">*</span></label>
            <input type="number" id="quick-receive-qty" value="${suggestedQty}" min="0.01" step="0.01" required 
              placeholder="100.50"
              class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>
          
          <div>
            <label class="block text-sm font-medium mb-1">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà PO</label>
            <input type="text" id="quick-receive-po" 
              class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>
          
          <div>
            <label class="block text-sm font-medium mb-1">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà IV <span class="text-red-500">*</span></label>
            <input type="text" id="quick-receive-iv" required 
              class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>
        </div>
      `;
      
      showModal('‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏î‡πà‡∏ß‡∏ô', content, async () => {
        const qty = parseFloat(document.getElementById('quick-receive-qty').value);
        const po = document.getElementById('quick-receive-po').value;
        const iv = document.getElementById('quick-receive-iv').value;
        
        if (!qty || qty <= 0 || isNaN(qty)) {
          showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
          return;
        }
        
        if (!iv) {
          showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà IV', 'error');
          return;
        }
        
        const result = await addStockMovement({
          type: 'receive',
          productId: productId,
          quantity: qty,
          poNumber: po,
          ivNumber: iv
        });
        
        if (result.success) {
          showToast('‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
          renderApp();
        } else {
          showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + result.error, 'error');
        }
      });
    };

    window.editStockMovement = (movementId) => {
      const movement = stockMovements.find(m => m.id === movementId);
      if (!movement) return;
      
      const product = products.find(p => p.id === movement.productId);
      if (!product) return;
      
      const isReceive = movement.type === 'receive';
      
      const content = `
        <div class="space-y-4">
          <div class="bg-blue-50 p-4 rounded-lg">
            <p class="font-bold text-lg">${product.name}</p>
            <p class="text-sm text-gray-600 mt-1">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó: ${isReceive ? 'üì• ‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤' : 'üì§ ‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å'}</p>
          </div>
          
          <div>
            <label class="block text-sm font-medium mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô <span class="text-red-500">*</span></label>
            <input type="number" id="edit-movement-qty" value="${movement.quantity}" min="0.01" step="0.01" required 
              placeholder="100.50"
              class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            <p class="text-xs text-gray-500 mt-1">‡∏´‡∏ô‡πà‡∏ß‡∏¢: ${product.unit}</p>
          </div>
          
          ${isReceive ? `
            <div>
              <label class="block text-sm font-medium mb-1">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà PO</label>
              <input type="text" id="edit-movement-po" value="${movement.poNumber || ''}" 
                class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
          ` : `
            <div>
              <label class="block text-sm font-medium mb-1">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</label>
              <input type="text" id="edit-movement-doc" value="${movement.docNumber || ''}" 
                class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
          `}
          
          <div>
            <label class="block text-sm font-medium mb-1">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà IV <span class="text-red-500">*</span></label>
            <input type="text" id="edit-movement-iv" value="${movement.ivNumber}" required 
              class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>
        </div>
      `;
      
      showModal('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', content, async () => {
        const newQty = parseFloat(document.getElementById('edit-movement-qty').value);
        const newIV = document.getElementById('edit-movement-iv').value;
        
        if (!newQty || newQty <= 0 || isNaN(newQty)) {
          showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
          return;
        }
        
        if (!newIV) {
          showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà IV', 'error');
          return;
        }
        
        const updates = {
          quantity: roundTo2Decimal(newQty),
          ivNumber: newIV,
          timestamp: movement.timestamp
        };
        
        if (isReceive) {
          updates.poNumber = document.getElementById('edit-movement-po').value;
        } else {
          updates.docNumber = document.getElementById('edit-movement-doc').value;
        }
        
        try {
          showLoading();
          
          // ‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πà‡∏≤‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà
          await db.collection('stockMovements').doc(movementId).delete();
          await db.collection('stockMovements').add({
            type: movement.type,
            productId: movement.productId,
            ...updates,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
          });
          
          await loadStockMovements();
          hideLoading();
          showToast('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
          renderApp();
        } catch (error) {
          hideLoading();
          showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');
        }
      });
    };

    window.deleteStockMovement = async (movementId) => {
      const movement = stockMovements.find(m => m.id === movementId);
      if (!movement) return;
      
      const product = products.find(p => p.id === movement.productId);
      if (!product) return;
      
      const isReceive = movement.type === 'receive';
      
      const content = `
        <div class="space-y-2">
          <p class="text-red-600 font-semibold">‚ö†Ô∏è ‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</p>
          <p class="mt-2">‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</p>
          <div class="bg-gray-50 p-3 rounded-lg mt-3">
            <p><strong>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤:</strong> ${product.name}</p>
            <p><strong>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó:</strong> ${isReceive ? 'üì• ‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤' : 'üì§ ‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å'}</p>
            <p><strong>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô:</strong> ${formatNumber(movement.quantity)} ${product.unit}</p>
            <p><strong>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà IV:</strong> ${movement.ivNumber}</p>
          </div>
          <p class="text-sm text-gray-600 mt-2">‡∏¢‡∏≠‡∏î‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏à‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏•‡∏ö</p>
        </div>
      `;
      
      showModal('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', content, async () => {
        try {
          showLoading();
          await db.collection('stockMovements').doc(movementId).delete();
          await loadStockMovements();
          hideLoading();
          showToast('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
          renderApp();
        } catch (error) {
          hideLoading();
          showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');
        }
      });
    };

    // Initialize
    auth.onAuthStateChanged(async (user) => {
      if (user) {
        currentUser = user;
        await loadProducts();
        await loadStockMovements();
        renderApp();
      } else {
        currentUser = null;
        renderApp();
      }
    });

    initElementSDK();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9bc93d8117d27b5c',t:'MTc2ODE4NTExNC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>