<!doctype html>
<html lang="th" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏£‡∏∞‡∏ö‡∏öÔøΩÔøΩ‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&amp;display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body {
      box-sizing: border-box;
      font-family: 'Sarabun', sans-serif;
    }
    * {
      box-sizing: border-box;
    }
    .sidebar-item {
      transition: all 0.2s ease;
    }
    .sidebar-item:hover {
      transform: translateX(4px);
    }
    .sidebar-item.active {
      background: linear-gradient(90deg, #3b82f6 0%, #1d4ed8 100%);
      box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
    }
    .card-hover {
      transition: all 0.3s ease;
    }
    .card-hover:hover {
      transform: translateY(-4px);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
    }
    .gradient-bg {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    .table-row:hover {
      background-color: #f8fafc;
    }
    .modal-overlay {
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
    }
    .btn-primary {
      background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
      transition: all 0.3s ease;
    }
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(59, 130, 246, 0.4);
    }
    .btn-success {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    }
    .btn-danger {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    }
    .status-badge {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }
    .status-normal {
      background: #dcfce7;
      color: #166534;
    }
    .status-low {
      background: #fee2e2;
      color: #991b1b;
    }
    .input-field {
      transition: all 0.2s ease;
      border: 2px solid #e2e8f0;
    }
    .input-field:focus {
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    .fade-in {
      animation: fadeIn 0.3s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .toast {
      animation: slideIn 0.3s ease;
    }
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    ::-webkit-scrollbar-track {
      background: #f1f5f9;
      border-radius: 4px;
    }
    ::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 4px;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }

    /* Mobile Responsive */
    .sidebar {
      transition: transform 0.3s ease;
    }
    
    @media (max-width: 768px) {
      .sidebar {
        position: fixed;
        top: 0;
        left: 0;
        height: 100%;
        z-index: 40;
        transform: translateX(-100%);
      }
      .sidebar.open {
        transform: translateX(0);
      }
      .sidebar-overlay {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 30;
      }
      .sidebar-overlay.open {
        display: block;
      }
      .mobile-header {
        display: flex !important;
      }
      .table-responsive {
        display: none;
      }
      .card-view {
        display: block !important;
      }
    }
    
    @media (min-width: 769px) {
      .mobile-header {
        display: none !important;
      }
      .table-responsive {
        display: table;
      }
      .card-view {
        display: none !important;
      }
    }
    
    .hamburger {
      display: flex;
      flex-direction: column;
      gap: 4px;
      cursor: pointer;
    }
    .hamburger span {
      width: 24px;
      height: 3px;
      background: white;
      border-radius: 2px;
      transition: all 0.3s ease;
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
 </head>
 <body class="h-full bg-gray-50">
  <div id="app" class="h-full w-full"><!-- Login Page -->
   <div id="loginPage" class="h-full w-full flex items-center justify-center gradient-bg">
    <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md mx-4 fade-in">
     <div class="text-center mb-8">
      <div class="w-20 h-20 bg-gradient-to-br from-blue-500 to-purple-600 rounded-2xl mx-auto mb-4 flex items-center justify-center shadow-lg">
       <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
       </svg>
      </div>
      <h1 id="loginTitle" class="text-2xl font-bold text-gray-800">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h1>
      <p id="loginCompany" class="text-gray-500 mt-2">SAHA PVC</p>
     </div>
     <div id="loginForm" class="space-y-4">
      <div><label class="block text-sm font-medium text-gray-700 mb-2">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label> <input type="email" id="emailInput" class="input-field w-full px-4 py-3 rounded-xl outline-none" placeholder="your@email.com">
      </div>
      <div><label class="block text-sm font-medium text-gray-700 mb-2">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label> <input type="password" id="passwordInput" class="input-field w-full px-4 py-3 rounded-xl outline-none" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
      </div>
      <div id="loginError" class="hidden text-red-500 text-sm text-center py-2 bg-red-50 rounded-lg"></div><button id="loginBtn" class="btn-primary w-full py-3 text-white font-semibold rounded-xl"> ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö </button>
     </div>
     <div id="loginLoading" class="hidden text-center py-4">
      <div class="inline-block w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
      <p class="text-gray-500 mt-2">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö...</p>
     </div>
    </div>
   </div><!-- Main App -->
   <div id="mainApp" class="hidden h-full w-full flex"><!-- Sidebar Overlay for Mobile -->
    <div id="sidebarOverlay" class="sidebar-overlay" onclick="toggleSidebar()"></div><!-- Sidebar -->
    <aside id="sidebar" class="sidebar w-64 bg-gradient-to-b from-slate-900 to-slate-800 text-white flex flex-col flex-shrink-0">
     <div class="p-6 border-b border-slate-700">
      <div class="flex items-center gap-3">
       <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-xl flex items-center justify-center">
        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
        </svg>
       </div>
       <div>
        <h1 id="sidebarTitle" class="font-bold text-lg">Stock System</h1>
        <p id="sidebarCompany" class="text-xs text-slate-400">SAHA PVC</p>
       </div>
      </div>
     </div>
     <nav class="flex-1 p-4 space-y-2 overflow-y-auto"><button onclick="showPage('dashboard')" class="sidebar-item active w-full flex items-center gap-3 px-4 py-3 rounded-xl text-left" data-page="dashboard">
       <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />
       </svg><span>‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</span> </button> <button onclick="showPage('stock')" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-left hover:bg-slate-700" data-page="stock">
       <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
       </svg><span>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏á‡πÄÔøΩÔøΩÔøΩ‡∏•‡∏∑‡∏≠</span> </button> <button onclick="showPage('receive')" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-left hover:bg-slate-700" data-page="receive">
       <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
       </svg><span>ÔøΩÔøΩÔøΩ‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</span> </button> <button onclick="showPage('issue')" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-left hover:bg-slate-700" data-page="issue">
       <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4" />
       </svg><span>‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</span> </button> <button onclick="showPage('stockByIV')" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-left hover:bg-slate-700" data-page="stockByIV">
       <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
       </svg><span>‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÅ‡∏¢‡∏Å IV</span> </button> <button onclick="showPage('movement')" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-left hover:bg-slate-700" data-page="movement">
       <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z" />
       </svg><span>‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß</span> </button> <button onclick="showPage('master')" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-left hover:bg-slate-700" data-page="master">
       <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
       </svg><span>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</span> </button>
     </nav>
     <div class="p-4 border-t border-slate-700">
      <div class="flex items-center gap-3 mb-3">
       <div class="w-10 h-10 bg-slate-600 rounded-full flex items-center justify-center">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24">
         <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
        </svg>
       </div>
       <div class="flex-1 min-w-0">
        <p id="userEmail" class="text-sm truncate">user@email.com</p>
        <p class="text-xs text-slate-400">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</p>
       </div>
      </div><button onclick="logout()" class="w-full flex items-center justify-center gap-2 px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg transition-colors">
       <svg class="w-4 h-4" fill="none" stroke="currentColor" viewbox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
       </svg><span class="text-sm">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</span> </button>
     </div>
    </aside><!-- Main Content -->
    <main class="flex-1 overflow-auto"><!-- Mobile Header -->
     <div class="mobile-header hidden bg-gradient-to-r from-blue-600 to-blue-700 text-white p-4 items-center justify-between sticky top-0 z-20 shadow-lg">
      <div class="flex items-center gap-3"><button onclick="toggleSidebar()" class="hamburger p-2"> <span></span> <span></span> <span></span> </button>
       <h1 id="mobilePageTitle" class="font-bold text-lg">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</h1>
      </div><button onclick="logout()" class="p-2">
       <svg class="w-6 h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
       </svg></button>
     </div><!-- Dashboard Page -->
     <div id="dashboardPage" class="p-6 fade-in">
      <div class="mb-6">
       <h2 class="text-2xl font-bold text-gray-800">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏° Dashboard</h2>
       <p class="text-gray-500">‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏áÔøΩÔøΩÔøΩ‡∏´ÔøΩÔøΩ‡∏∑‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
       <div class="card-hover bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
        <div class="flex items-center justify-between">
         <div>
          <p class="text-gray-500 text-sm">ÔøΩÔøΩ‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´ÔøΩÔøΩ‡∏î</p>
          <p id="totalProducts" class="text-3xl font-bold text-gray-800 mt-1">0</p>
          <p class="text-xs text-gray-400 mt-1">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (SKU)</p>
         </div>
         <div class="w-14 h-14 bg-blue-100 rounded-2xl flex items-center justify-center">
          <svg class="w-7 h-7 text-blue-600" fill="none" stroke="currentColor" viewbox="0 0 24 24">
           <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
          </svg>
         </div>
        </div>
       </div>
       <div class="card-hover bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
        <div class="flex items-center justify-between">
         <div>
          <p class="text-gray-500 text-sm">‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏£‡∏ß‡∏°</p>
          <p id="totalStock" class="text-3xl font-bold text-gray-800 mt-1">0</p>
          <p class="text-xs text-gray-400 mt-1">‡∏ä‡∏¥‡πâ‡∏ô</p>
         </div>
         <div class="w-14 h-14 bg-green-100 rounded-2xl flex items-center justify-center">
          <svg class="w-7 h-7 text-green-600" fill="none" stroke="currentColor" viewbox="0 0 24 24">
           <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
          </svg>
         </div>
        </div>
       </div>
       <div class="card-hover bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
        <div class="flex items-center justify-between">
         <div>
          <p class="text-gray-500 text-sm">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ï‡πà‡∏≥</p>
          <p id="lowStockCount" class="text-3xl font-bold text-red-600 mt-1">0</p>
          <p class="text-xs text-gray-400 mt-1">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>
         </div>
         <div class="w-14 h-14 bg-red-100 rounded-2xl flex items-center justify-center">
          <svg class="w-7 h-7 text-red-600" fill="none" stroke="currentColor" viewbox="0 0 24 24">
           <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
          </svg>
         </div>
        </div>
       </div>
       <div class="card-hover bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
        <div class="flex items-center justify-between">
         <div>
          <p class="text-gray-500 text-sm">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</p>
          <p id="todayTransactions" class="text-3xl font-bold text-purple-600 mt-1">0</p>
          <p class="text-xs text-gray-400 mt-1">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>
         </div>
         <div class="w-14 h-14 bg-purple-100 rounded-2xl flex items-center justify-center">
          <svg class="w-7 h-7 text-purple-600" fill="none" stroke="currentColor" viewbox="0 0 24 24">
           <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
          </svg>
         </div>
        </div>
       </div>
      </div>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
       <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
        <h3 class="font-semibold text-gray-800 mb-4">üî¥ ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ï‡πà‡∏≥</h3>
        <div id="lowStockList" class="space-y-3 max-h-80 overflow-y-auto">
         <p class="text-gray-400 text-center py-8">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ï‡πà‡∏≥</p>
        </div>
       </div>
       <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
        <h3 class="font-semibold text-gray-800 mb-4">üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h3>
        <div id="recentTransactions" class="space-y-3 max-h-80 overflow-y-auto">
         <p class="text-gray-400 text-center py-8">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤ÔøΩÔøΩ‡∏Å‡∏≤‡∏£</p>
        </div>
       </div>
      </div>
     </div><!-- Stock Balance Page -->
     <div id="stockPage" class="hidden p-6 fade-in">
      <div class="mb-6">
       <h2 class="text-2xl font-bold text-gray-800">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</h2>
       <p class="text-gray-500">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™ÔøΩÔøΩ‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>
      </div>
      <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
       <div class="p-4 border-b border-gray-100 flex flex-wrap gap-4 items-center">
        <div class="flex-1 min-w-64"><input type="text" id="stockSearch" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤..." class="input-field w-full px-4 py-2 rounded-xl outline-none" oninput="filterStock()">
        </div>
        <div class="flex gap-2"><button onclick="sortStock('name')" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-xl text-sm font-medium transition-colors">‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏ä‡∏∑‡πà‡∏≠ ‡∏Å-‡∏Æ</button> <button onclick="sortStock('qty')" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-xl text-sm font-medium transition-colors">‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</button>
        </div>
       </div><!-- Desktop Table View -->
       <div class="overflow-x-auto">
        <table class="w-full table-responsive">
         <thead class="bg-gray-50">
          <tr>
           <th class="px-6 py-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
           <th class="px-6 py-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏±‡∏ö</th>
           <th class="px-6 py-4 text-right text-xs font-semibold text-gray-500 uppercase tracking-wider">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th>
           <th class="px-6 py-4 text-right text-xs font-semibold text-gray-500 uppercase tracking-wider">‡∏à‡∏∏‡∏î‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</th>
           <th class="px-6 py-4 text-center text-xs font-semibold text-gray-500 uppercase tracking-wider">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
          </tr>
         </thead>
         <tbody id="stockTableBody" class="divide-y divide-gray-100">
          <tr>
           <td colspan="5" class="px-6 py-12 text-center text-gray-400">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td>
          </tr>
         </tbody>
        </table>
       </div><!-- Mobile Card View -->
       <div id="stockCardView" class="card-view hidden p-4 space-y-4">
        <p class="text-gray-400 text-center py-12">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
       </div>
      </div>
     </div><!-- Receive Page -->
     <div id="receivePage" class="hidden p-6 fade-in">
      <div class="mb-6">
       <h2 class="text-2xl font-bold text-gray-800">‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h2>
       <p class="text-gray-500">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏™‡∏ï‡πá‡∏≠‡∏Å</p>
      </div>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
       <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
        <h3 class="font-semibold text-gray-800 mb-4">‚úèÔ∏è ‡∏ö‡∏±‡∏ô‡∏óÔøΩÔøΩ‡∏Å‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏ô‡πÄ‡∏≠‡∏á</h3>
        <div class="space-y-4">
         <div><label class="block text-sm font-medium text-gray-700 mb-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà *</label> <input type="date" id="receiveDate" class="input-field w-full px-4 py-3 rounded-xl outline-none">
         </div>
         <div><label class="block text-sm font-medium text-gray-700 mb-2">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ *</label> <select id="receiveProduct" class="input-field w-full px-4 py-3 rounded-xl outline-none" onchange="updateReceiveUnit()"> <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ --</option> </select>
         </div>
         <div><label class="block text-sm font-medium text-gray-700 mb-2">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏±‡∏ö</label> <input type="text" id="receiveUnit" class="input-field w-full px-4 py-3 rounded-xl outline-none bg-gray-50" readonly>
         </div>
         <div><label class="block text-sm font-medium text-gray-700 mb-2">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô *</label> <input type="number" id="receiveQty" class="input-field w-full px-4 py-3 rounded-xl outline-none" min="0.01" step="0.01" placeholder="0.00">
         </div>
         <div><label class="block text-sm font-medium text-gray-700 mb-2">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà PO</label> <input type="text" id="receivePO" class="input-field w-full px-4 py-3 rounded-xl outline-none" placeholder="‡∏ñ‡πâ‡∏≤‡∏°‡∏µ">
         </div>
         <div><label class="block text-sm font-medium text-gray-700 mb-2">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà IV *</label> <input type="text" id="receiveIV" class="input-field w-full px-4 py-3 rounded-xl outline-none" placeholder="‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô">
         </div><button onclick="showReceiveConfirm()" class="btn-success w-full py-3 text-white font-semibold rounded-xl"> ÔøΩÔøΩ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ </button>
        </div>
       </div>
       <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
        <h3 class="font-semibold text-gray-800 mb-4">üì§ ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏à‡∏≤‡∏Å Excel</h3>
        <div class="border-2 border-dashed border-gray-200 rounded-xl p-8 text-center">
         <svg class="w-12 h-12 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewbox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
         </svg>
         <p class="text-gray-500 mb-4">‡∏•‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏°‡∏≤‡∏ß‡∏≤‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏ûÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩ‡πÄ‡∏•ÔøΩÔøΩ‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå</p><input type="file" id="receiveExcelFile" accept=".xlsx,.xls" class="hidden" onchange="handleReceiveExcel(event)"> <button onclick="document.getElementById('receiveExcelFile').click()" class="px-6 py-2 bg-blue-100 text-blue-600 font-medium rounded-xl hover:bg-blue-200 transition-colors"> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel </button>
         <p class="text-xs text-gray-400 mt-4">‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö: ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (DD-MM-YYYY), ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤, ÔøΩÔøΩ‡∏≥‡∏ô‡∏ß‡∏ô, ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà PO, ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà IV</p><button onclick="downloadReceiveTemplate()" class="mt-3 text-xs text-blue-600 hover:underline">üì• ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏•‡∏ï Excel</button>
        </div>
       </div>
      </div>
      <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
       <div class="p-4 border-b border-gray-100">
        <div class="flex justify-between items-center mb-4">
         <h3 class="font-semibold text-gray-800">üìã ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡πÄ‡∏ÇÔøΩÔøΩ‡∏≤</h3>
         <div class="flex gap-2"><button onclick="toggleReceiveFilters()" class="px-4 py-2 bg-blue-100 text-blue-600 font-medium rounded-xl hover:bg-blue-200 transition-colors text-sm"> üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡∏±‡πâ‡∏ô‡∏™‡∏π‡∏á </button> <button onclick="exportReceiveHistory()" class="px-4 py-2 bg-green-100 text-green-600 font-medium rounded-xl hover:bg-green-200 transition-colors text-sm"> ÔøΩÔøΩ Export Excel </button>
         </div>
        </div>
        <div id="receiveFilters" class="hidden grid grid-cols-1 md:grid-cols-4 gap-4 p-4 bg-gray-50 rounded-xl">
         <div><label class="block text-xs font-medium text-gray-700 mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</label> <input type="date" id="receiveFilterDateStart" class="input-field w-full px-3 py-2 rounded-lg outline-none text-sm" onchange="filterReceiveHistory()">
         </div>
         <div><label class="block text-xs font-medium text-gray-700 mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</label> <input type="date" id="receiveFilterDateEnd" class="input-field w-full px-3 py-2 rounded-lg outline-none text-sm" onchange="filterReceiveHistory()">
         </div>
         <div><label class="block text-xs font-medium text-gray-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label> <input type="text" id="receiveFilterProduct" class="input-field w-full px-3 py-2 rounded-lg outline-none text-sm" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤..." oninput="filterReceiveHistory()">
         </div>
         <div><label class="block text-xs font-medium text-gray-700 mb-1">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà IV</label> <input type="text" id="receiveFilterIV" class="input-field w-full px-3 py-2 rounded-lg outline-none text-sm" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ IV..." oninput="filterReceiveHistory()">
         </div>
         <div><label class="block text-xs font-medium text-gray-700 mb-1">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà PO</label> <input type="text" id="receiveFilterPO" class="input-field w-full px-3 py-2 rounded-lg outline-none text-sm" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ PO..." oninput="filterReceiveHistory()">
         </div>
         <div class="md:col-span-4 flex justify-between items-center"><span id="receiveFilterCount" class="text-sm text-gray-600">‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span> <button onclick="clearReceiveFilters()" class="px-3 py-1 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors text-sm"> ‡∏•ÔøΩÔøΩÔøΩ‡∏≤‡∏á‡∏ü‡∏¥‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå </button>
         </div>
        </div>
       </div>
       <div class="overflow-x-auto">
        <table class="w-full">
         <thead class="bg-gray-50">
          <tr>
           <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
           <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase">ÔøΩÔøΩ‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
           <th class="px-6 py-3 text-right text-xs font-semibold text-gray-500 uppercase">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
           <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase">PO</th>
           <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase">IV</th>
           <th class="px-6 py-3 text-center text-xs font-semibold text-gray-500 uppercase">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
          </tr>
         </thead>
         <tbody id="receiveHistoryBody" class="divide-y divide-gray-100">
          <tr>
           <td colspan="6" class="px-6 py-8 text-center text-gray-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td>
          </tr>
         </tbody>
        </table>
       </div>
       <div id="receivePagination" class="p-4 border-t border-gray-100 flex justify-center"><button id="receiveLoadMoreBtn" onclick="loadMoreReceive()" class="hidden px-6 py-2 bg-blue-100 text-blue-600 font-medium rounded-xl hover:bg-blue-200 transition-colors"> ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡πÅ‡∏™‡∏î‡∏á <span id="receiveCurrentCount">0</span> ‡∏à‡∏≤‡∏Å <span id="receiveTotalCount">0</span>) </button>
       </div>
      </div>
     </div><!-- Issue Page -->
     <div id="issuePage" class="hidden p-6 fade-in">
      <div class="mb-6">
       <h2 class="text-2xl font-bold text-gray-800">‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h2>
       <p class="text-gray-500">‡∏ï‡∏±‡∏î‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠ÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩ‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å‡∏Ç‡∏≠‡∏á</p>
      </div>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
       <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
        <h3 class="font-semibold text-gray-800 mb-4">üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏ô‡πÄ‡∏≠‡∏á</h3>
        <div class="space-y-4">
         <div><label class="block text-sm font-medium text-gray-700 mb-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà *</label> <input type="date" id="issueDate" class="input-field w-full px-4 py-3 rounded-xl outline-none">
         </div>
         <div><label class="block text-sm font-medium text-gray-700 mb-2">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ *</label> <select id="issueProduct" class="input-field w-full px-4 py-3 rounded-xl outline-none" onchange="updateIssueIVOptions()"> <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâÔøΩÔøΩÔøΩ --</option> </select>
         </div>
         <div><label class="block text-sm font-medium text-gray-700 mb-2">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏±‡∏ö</label> <input type="text" id="issueUnit" class="input-field w-full px-4 py-3 rounded-xl outline-none bg-gray-50" readonly>
         </div>
         <div><label class="block text-sm font-medium text-gray-700 mb-2">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà IV * (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡πá‡∏≠‡∏ï‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ï‡∏±‡∏î‡∏™‡∏ï‡πá‡∏≠‡∏Å)</label> <select id="issueIV" class="input-field w-full px-4 py-3 rounded-xl outline-none"> <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâÔøΩÔøΩÔøΩ‡∏Å‡πà‡∏≠‡∏ô --</option> </select>
         </div>
         <div><label class="block text-sm font-medium text-gray-700 mb-2">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô *</label> <input type="number" id="issueQty" class="input-field w-full px-4 py-3 rounded-xl outline-none" min="0.01" step="0.01" placeholder="0.00">
         </div>
         <div><label class="block text-sm font-medium text-gray-700 mb-2">‡πÄÔøΩÔøΩ‡∏Ç‡∏óÔøΩÔøΩÔøΩ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</label> <input type="text" id="issueDocNo" class="input-field w-full px-4 py-3 rounded-xl outline-none" placeholder="‡∏ñ‡πâ‡∏≤‡∏°‡∏µ">
         </div>
         <div id="issueAvailableInfo" class="hidden p-3 bg-blue-50 rounded-xl text-sm text-blue-700"></div><button onclick="showIssueConfirm()" class="btn-danger w-full py-3 text-white font-semibold rounded-xl"> ‚úì ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å </button>
        </div>
       </div>
       <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
        <h3 class="font-semibold text-gray-800 mb-4">üì§ ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏àÔøΩÔøΩ‡∏Å Excel</h3>
        <div class="border-2 border-dashed border-gray-200 rounded-xl p-8 text-center">
         <svg class="w-12 h-12 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewbox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
         </svg>
         <p class="text-gray-500 mb-4">‡∏•‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏°‡∏≤‡∏ß‡∏≤‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå</p><input type="file" id="issueExcelFile" accept=".xlsx,.xls" class="hidden" onchange="handleIssueExcel(event)"> <button onclick="document.getElementById('issueExcelFile').click()" class="px-6 py-2 bg-blue-100 text-blue-600 font-medium rounded-xl hover:bg-blue-200 transition-colors"> ‡πÄ‡∏•‡∏∑‡∏≠ÔøΩÔøΩÔøΩÔøΩ‡πÑ‡∏ü‡∏•‡πå Excel </button>
         <p class="text-xs text-gray-400 mt-4">‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö: ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (DD-MM-YYYY), ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤, ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô, ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà IV, ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</p><button onclick="downloadIssueTemplate()" class="mt-3 text-xs text-blue-600 hover:underline">üì• ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏•‡∏ï Excel</button>
         <p class="text-xs text-orange-500 mt-2">‚ö†Ô∏è ‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î Excel ‡∏à‡∏∞‡πÄ‡∏ä‡πá‡∏Ñ‡πÅ‡∏Ñ‡πà‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏™‡∏ï‡πá‡∏≠‡∏Å ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡πá‡∏Ñ‡πÅ‡∏¢‡∏Å‡∏£‡∏≤‡∏¢ IV ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏≤‡∏£ÔøΩÔøΩ‡∏µ‡∏¢ÔøΩÔøΩÔøΩ‡∏°‡∏∑‡∏≠</p>
        </div>
       </div>
      </div>
      <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
       <div class="p-4 border-b border-gray-100">
        <div class="flex justify-between items-center mb-4">
         <h3 class="font-semibold text-gray-800">üìã ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ÅÔøΩÔøΩÔøΩ‡∏£‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å</h3>
         <div class="flex gap-2"><button onclick="toggleIssueFilters()" class="px-4 py-2 bg-blue-100 text-blue-600 font-medium rounded-xl hover:bg-blue-200 transition-colors text-sm"> üîç ‡∏Ñ‡πâÔøΩÔøΩ‡∏´‡∏≤‡∏Ç‡∏±‡πâ‡∏ô‡∏™‡∏π‡∏á </button> <button onclick="exportIssueHistory()" class="px-4 py-2 bg-green-100 text-green-600 font-medium rounded-xl hover:bg-green-200 transition-colors text-sm"> üì• Export Excel </button>
         </div>
        </div>
        <div id="issueFilters" class="hidden grid grid-cols-1 md:grid-cols-4 gap-4 p-4 bg-gray-50 rounded-xl">
         <div><label class="block text-xs font-medium text-gray-700 mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</label> <input type="date" id="issueFilterDateStart" class="input-field w-full px-3 py-2 rounded-lg outline-none text-sm" onchange="filterIssueHistory()">
         </div>
         <div><label class="block text-xs font-medium text-gray-700 mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</label> <input type="date" id="issueFilterDateEnd" class="input-field w-full px-3 py-2 rounded-lg outline-none text-sm" onchange="filterIssueHistory()">
         </div>
         <div><label class="block text-xs font-medium text-gray-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label> <input type="text" id="issueFilterProduct" class="input-field w-full px-3 py-2 rounded-lg outline-none text-sm" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤..." oninput="filterIssueHistory()">
         </div>
         <div><label class="block text-xs font-medium text-gray-700 mb-1">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà IV</label> <input type="text" id="issueFilterIV" class="input-field w-full px-3 py-2 rounded-lg outline-none text-sm" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ IV..." oninput="filterIssueHistory()">
         </div>
         <div><label class="block text-xs font-medium text-gray-700 mb-1">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</label> <input type="text" id="issueFilterDocNo" class="input-field w-full px-3 py-2 rounded-lg outline-none text-sm" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£..." oninput="filterIssueHistory()">
         </div>
         <div class="md:col-span-4 flex justify-between items-center"><span id="issueFilterCount" class="text-sm text-gray-600">‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span> <button onclick="clearIssueFilters()" class="px-3 py-1 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors text-sm"> ‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏¥‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå </button>
         </div>
        </div>
       </div>
       <div class="overflow-x-auto">
        <table class="w-full">
         <thead class="bg-gray-50">
          <tr>
           <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
           <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
           <th class="px-6 py-3 text-right text-xs font-semibold text-gray-500 uppercase">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
           <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase">IV</th>
           <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</th>
           <th class="px-6 py-3 text-center text-xs font-semibold text-gray-500 uppercase">‡∏à‡∏±ÔøΩÔøΩÔøΩ‡∏Å‡∏≤‡∏£</th>
          </tr>
         </thead>
         <tbody id="issueHistoryBody" class="divide-y divide-gray-100">
          <tr>
           <td colspan="6" class="px-6 py-8 text-center text-gray-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td>
          </tr>
         </tbody>
        </table>
       </div>
       <div id="issuePagination" class="p-4 border-t border-gray-100 flex justify-center"><button id="issueLoadMoreBtn" onclick="loadMoreIssue()" class="hidden px-6 py-2 bg-blue-100 text-blue-600 font-medium rounded-xl hover:bg-blue-200 transition-colors"> ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡πÅ‡∏™‡∏î‡∏á <span id="issueCurrentCount">0</span> ‡∏à‡∏≤‡∏Å <span id="issueTotalCount">0</span>) </button>
       </div>
      </div>
     </div><!-- Stock by IV Page -->
     <div id="stockByIVPage" class="hidden p-6 fade-in">
      <div class="mb-6">
       <h2 class="text-2xl font-bold text-gray-800">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÅ‡∏¢‡∏Å IV</h2>
       <p class="text-gray-500">‡∏î‡∏π‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÄ‡∏•‡∏Ç IV</p>
      </div>
      <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 mb-6">
       <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div><label class="block text-sm font-medium text-gray-700 mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label> <select id="stockByIVProduct" class="input-field w-full px-4 py-3 rounded-xl outline-none" onchange="loadStockByIV()"> <option value="">-- ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î --</option> </select>
        </div>
        <div><label class="block text-sm font-medium text-gray-700 mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å IV</label> <select id="stockByIVSelect" class="input-field w-full px-4 py-3 rounded-xl outline-none" onchange="filterStockByIV()"> <option value="">-- ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î --</option> </select>
        </div>
       </div>
      </div>
      <div id="stockByIVContent" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
       <p class="text-gray-400 text-center py-12 col-span-full">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
      </div>
     </div><!-- Movement Page -->
     <div id="movementPage" class="hidden p-6 fade-in">
      <div class="mb-6">
       <h2 class="text-2xl font-bold text-gray-800">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h2>
       <p class="text-gray-500">‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤-‡∏≠‡∏≠‡∏Å ‡∏Ç‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏£‡∏≤‡∏¢‡∏ï‡∏±‡∏ß (Stock Card)</p>
      </div>
      <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 mb-6">
       <div><label class="block text-sm font-medium text-gray-700 mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label> <select id="movementProduct" class="input-field w-full px-4 py-3 rounded-xl outline-none" onchange="loadMovement()"> <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ --</option> </select>
       </div>
      </div>
      <div id="movementSummary" class="hidden bg-gradient-to-r from-blue-500 to-blue-600 rounded-2xl p-6 mb-6 text-white">
       <div class="flex items-center justify-between">
        <div>
         <p class="text-blue-100 text-sm">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</p>
         <h3 id="movementProductName" class="text-2xl font-bold">-</h3>
        </div>
        <div>
         <p class="text-blue-100 text-sm">‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</p>
         <p id="movementBalance" class="text-3xl font-bold">0</p>
        </div>
       </div>
      </div>
      <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
       <div class="overflow-x-auto">
        <table class="w-full">
         <thead class="bg-gray-50">
          <tr>
           <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
           <th class="px-6 py-3 text-center text-xs font-semibold text-gray-500 uppercase">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
           <th class="px-6 py-3 text-right text-xs font-semibold text-gray-500 uppercase">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
           <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase">PO/IV</th>
           <th class="px-6 py-3 text-right text-xs font-semibold text-gray-500 uppercase">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th>
          </tr>
         </thead>
         <tbody id="movementTableBody" class="divide-y divide-gray-100">
          <tr>
           <td colspan="5" class="px-6 py-12 text-center text-gray-400">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ÑÔøΩÔøΩ‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß</td>
          </tr>
         </tbody>
        </table>
       </div>
       <div id="movementPagination" class="p-4 border-t border-gray-100 flex justify-center"><button id="movementLoadMoreBtn" onclick="loadMoreMovement()" class="hidden px-6 py-2 bg-blue-100 text-blue-600 font-medium rounded-xl hover:bg-blue-200 transition-colors"> ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡πÅ‡∏™‡∏î‡∏á <span id="movementCurrentCount">0</span> ‡∏à‡∏≤‡∏Å <span id="movementTotalCount">0</span>) </button>
       </div>
      </div>
     </div><!-- Master Data Page -->
     <div id="masterPage" class="hidden p-6 fade-in">
      <div class="mb-6">
       <h2 class="text-2xl font-bold text-gray-800">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (Master Data)</h2>
       <p class="text-gray-500">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å‡∏Ç‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</p>
      </div>
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
       <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
        <h3 class="font-semibold text-gray-800 mb-4">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà</h3>
        <div class="space-y-4">
         <div><label class="block text-sm font-medium text-gray-700 mb-2">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ *</label> <input type="text" id="newProductName" class="input-field w-full px-4 py-3 rounded-xl outline-none" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤">
         </div>
         <div class="grid grid-cols-2 gap-4">
          <div><label class="block text-sm font-medium text-gray-700 mb-2">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏±‡∏ö *</label> <input type="text" id="newProductUnit" class="input-field w-full px-4 py-3 rounded-xl outline-none" placeholder="‡∏äÔøΩÔøΩ‡πâ‡∏ô, ‡∏Å‡∏•‡πà‡∏≠‡∏á...">
          </div>
          <div><label class="block text-sm font-medium text-gray-700 mb-2">‡∏™ÔøΩÔøΩ‡πá‡∏≠‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥</label> <input type="number" id="newProductMinStock" class="input-field w-full px-4 py-3 rounded-xl outline-none" min="0" value="10">
          </div>
         </div><button onclick="showAddProductConfirm()" class="btn-primary w-full py-3 text-white font-semibold rounded-xl"> ‚úì ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ </button>
        </div>
       </div>
       <div class="lg:col-span-2 bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
        <h3 class="font-semibold text-gray-800 mb-4">üì§ ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤/‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å Excel</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
         <div class="border-2 border-dashed border-gray-200 rounded-xl p-6 text-center"><input type="file" id="masterExcelFile" accept=".xlsx,.xls" class="hidden" onchange="handleMasterExcel(event)"> <button onclick="document.getElementById('masterExcelFile').click()" class="px-6 py-3 bg-blue-100 text-blue-600 font-medium rounded-xl hover:bg-blue-200 transition-colors"> üì• Import Excel </button>
          <p class="text-xs text-gray-400 mt-2">‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö: ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤, ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏±‡∏ö, ‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥</p>
         </div>
         <div class="border-2 border-dashed border-gray-200 rounded-xl p-6 text-center"><button onclick="exportMasterData()" class="px-6 py-3 bg-green-100 text-green-600 font-medium rounded-xl hover:bg-green-200 transition-colors"> üì§ Export Excel </button>
          <p class="text-xs text-gray-400 mt-2">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
         </div>
        </div>
       </div>
      </div>
      <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
       <div class="p-4 border-b border-gray-100"><input type="text" id="masterSearch" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤..." class="input-field w-full max-w-md px-4 py-2 rounded-xl outline-none" oninput="filterMaster()">
       </div>
       <div class="overflow-x-auto">
        <table class="w-full">
         <thead class="bg-gray-50">
          <tr>
           <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
           <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏±‡∏ö</th>
           <th class="px-6 py-3 text-right text-xs font-semibold text-gray-500 uppercase">ÔøΩÔøΩ‡∏ï‡πá‡∏≠‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥</th>
           <th class="px-6 py-3 text-center text-xs font-semibold text-gray-500 uppercase">‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
          </tr>
         </thead>
         <tbody id="masterTableBody" class="divide-y divide-gray-100">
          <tr>
           <td colspan="4" class="px-6 py-8 text-center text-gray-400">‡∏Å‡∏≥ÔøΩÔøΩÔøΩ‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td>
          </tr>
         </tbody>
        </table>
       </div>
      </div>
     </div>
    </main>
   </div><!-- Confirmation Modal -->
   <div id="confirmModal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-overlay">
    <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4 overflow-hidden fade-in">
     <div id="confirmModalHeader" class="p-6 bg-gradient-to-r from-blue-500 to-blue-600 text-white">
      <h3 id="confirmModalTitle" class="text-xl font-bold">‡∏¢ÔøΩÔøΩ‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</h3>
     </div>
     <div id="confirmModalBody" class="p-6"><!-- Dynamic content -->
     </div>
     <div class="p-4 bg-gray-50 flex justify-end gap-3"><button onclick="closeConfirmModal()" class="px-6 py-2 bg-gray-200 text-gray-700 font-medium rounded-xl hover:bg-gray-300 transition-colors"> ‡∏¢ÔøΩÔøΩÔøΩ‡πÄ‡∏•‡∏¥‡∏Å </button> <button id="confirmModalBtn" class="btn-primary px-6 py-2 text-white font-medium rounded-xl"> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô </button>
     </div>
    </div>
   </div><!-- Toast Container -->
   <div id="toastContainer" class="fixed top-4 right-4 z-50 space-y-2"></div>
  </div>
  <script>
    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyD98l2HfqhFhrKIsL3Rl88dSHFKbVm8wMA",
      authDomain: "saha-pvc-auth.firebaseapp.com",
      projectId: "saha-pvc-auth",
      storageBucket: "saha-pvc-auth.firebasestorage.app",
      messagingSenderId: "510907547342",
      appId: "1:510907547342:web:dbeb44ed7465789ce31a9f",
      measurementId: "GG-G5E6QFS2JQ"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // App State
    let currentUser = null;
    let products = [];
    let transactions = [];
    let stockByIV = {};
    let currentPage = 'dashboard';
    let stockSortField = 'name';
    let stockSortAsc = true;

    // Pagination State
    let receiveLastDoc = null;
    let receiveHasMore = true;
    let receiveAllDocs = [];
    let issueLastDoc = null;
    let issueHasMore = true;
    let issueAllDocs = [];
    let movementLastDoc = null;
    let movementHasMore = true;
    let movementAllDocs = [];

    // Config for Element SDK
    const defaultConfig = {
      app_title: '‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤',
      company_name: 'SAHA PVC'
    };

    let config = { ...defaultConfig };

    // Initialize Element SDK
    if (window.elementSdk) {
      window.elementSdk.init({
        defaultConfig,
        onConfigChange: async (newConfig) => {
          config = { ...defaultConfig, ...newConfig };
          applyConfig();
        },
        mapToCapabilities: (cfg) => ({
          recolorables: [],
          borderables: [],
          fontEditable: undefined,
          fontSizeable: undefined
        }),
        mapToEditPanelValues: (cfg) => new Map([
          ['app_title', cfg.app_title || defaultConfig.app_title],
          ['company_name', cfg.company_name || defaultConfig.company_name]
        ])
      });
    }

    function applyConfig() {
      const title = config.app_title || defaultConfig.app_title;
      const company = config.company_name || defaultConfig.company_name;
      
      const loginTitle = document.getElementById('loginTitle');
      const loginCompany = document.getElementById('loginCompany');
      const sidebarTitle = document.getElementById('sidebarTitle');
      const sidebarCompany = document.getElementById('sidebarCompany');
      
      if (loginTitle) loginTitle.textContent = title;
      if (loginCompany) loginCompany.textContent = company;
      if (sidebarTitle) sidebarTitle.textContent = 'Stock System';
      if (sidebarCompany) sidebarCompany.textContent = company;
    }

    // Authentication
    auth.onAuthStateChanged((user) => {
      if (user) {
        currentUser = user;
        document.getElementById('loginPage').classList.add('hidden');
        document.getElementById('mainApp').classList.remove('hidden');
        document.getElementById('mainApp').classList.add('flex');
        document.getElementById('userEmail').textContent = user.email;
        initializeApp();
      } else {
        currentUser = null;
        document.getElementById('loginPage').classList.remove('hidden');
        document.getElementById('mainApp').classList.add('hidden');
        document.getElementById('mainApp').classList.remove('flex');
      }
    });

    document.getElementById('loginBtn').addEventListener('click', login);
    document.getElementById('passwordInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') login();
    });

    async function login() {
      const email = document.getElementById('emailInput').value.trim();
      const password = document.getElementById('passwordInput').value;
      const errorDiv = document.getElementById('loginError');
      const loginForm = document.getElementById('loginForm');
      const loginLoading = document.getElementById('loginLoading');

      if (!email || !password) {
        errorDiv.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅÔøΩÔøΩ‡∏∞‡∏£‡∏´‡∏±‡∏™ÔøΩÔøΩ‡πà‡∏≤‡∏ô';
        errorDiv.classList.remove('hidden');
        return;
      }

      loginForm.classList.add('hidden');
      loginLoading.classList.remove('hidden');
      errorDiv.classList.add('hidden');

      try {
        await auth.signInWithEmailAndPassword(email, password);
      } catch (error) {
        loginForm.classList.remove('hidden');
        loginLoading.classList.add('hidden');
        let errorMessage = '‡πÄ‡∏Å‡∏¥ÔøΩÔøΩ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏îÔøΩÔøΩÔøΩ‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏öÔøΩÔøΩ';
        if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
          errorMessage = '‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
        } else if (error.code === 'auth/invalid-email') {
          errorMessage = '‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏≠ÔøΩÔøΩ‡πÄ‡∏°‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
        }
        errorDiv.textContent = errorMessage;
        errorDiv.classList.remove('hidden');
      }
    }

    function logout() {
      auth.signOut();
    }

    // Initialize App Data
    function initializeApp() {
      applyConfig();
      setupRealtimeListeners();
      setDefaultDates();
    }

    function setDefaultDates() {
      const today = new Date().toISOString().split('T')[0];
      const receiveDate = document.getElementById('receiveDate');
      const issueDate = document.getElementById('issueDate');
      if (receiveDate) receiveDate.value = today;
      if (issueDate) issueDate.value = today;
    }

    function setupRealtimeListeners() {
      // Products listener
      db.collection('products').onSnapshot((snapshot) => {
        products = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        products.sort((a, b) => a.name.localeCompare(b.name, 'th', { numeric: true, sensitivity: 'base' }));
        updateProductSelects();
        renderCurrentPage();
      });

      // Transactions listener
      db.collection('transactions').orderBy('timestamp', 'asc').onSnapshot((snapshot) => {
        transactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        calculateStockByIV();
        renderCurrentPage();
      });
    }

    function calculateStockByIV() {
      stockByIV = {};
      transactions.forEach(t => {
        const key = `${t.productId}_${t.iv}`;
        if (!stockByIV[key]) {
          stockByIV[key] = {
            productId: t.productId,
            productName: t.productName,
            iv: t.iv,
            qty: 0
          };
        }
        if (t.type === 'receive') {
          stockByIV[key].qty += t.qty;
        } else {
          stockByIV[key].qty -= t.qty;
        }
      });
    }

    function getProductStock(productId) {
      return Object.values(stockByIV)
        .filter(s => s.productId === productId)
        .reduce((sum, s) => sum + s.qty, 0);
    }

    function updateProductSelects() {
      const selects = ['receiveProduct', 'issueProduct', 'stockByIVProduct', 'movementProduct'];
      selects.forEach(selectId => {
        const select = document.getElementById(selectId);
        if (select) {
          const currentValue = select.value;
          select.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ --</option>';
          products.forEach(p => {
            select.innerHTML += `<option value="${p.id}">${p.name}</option>`;
          });
          select.value = currentValue;
        }
      });
    }

    // Page Navigation
    function showPage(page) {
      currentPage = page;
      document.querySelectorAll('[id$="Page"]').forEach(p => {
        if (p.id !== 'loginPage') p.classList.add('hidden');
      });
      document.getElementById(page + 'Page').classList.remove('hidden');

      document.querySelectorAll('.sidebar-item').forEach(item => {
        item.classList.remove('active');
        item.classList.add('hover:bg-slate-700');
      });
      const activeItem = document.querySelector(`[data-page="${page}"]`);
      if (activeItem) {
        activeItem.classList.add('active');
        activeItem.classList.remove('hover:bg-slate-700');
      }

      // Update mobile header title
      const pageTitles = {
        dashboard: '‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°',
        stock: '‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏á‡πÄ‡∏´ÔøΩÔøΩÔøΩ‡∏∑‡∏≠',
        receive: '‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤',
        issue: '‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤',
        stockByIV: '‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÅ‡∏¢‡∏Å IV',
        movement: '‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß',
        master: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'
      };
      const mobileTitle = document.getElementById('mobilePageTitle');
      if (mobileTitle) {
        mobileTitle.textContent = pageTitles[page] || 'Stock System';
      }

      // Close sidebar on mobile after navigation
      if (window.innerWidth <= 768) {
        toggleSidebar();
      }

      renderCurrentPage();
    }

    // Toggle Sidebar for Mobile
    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('sidebarOverlay');
      sidebar.classList.toggle('open');
      overlay.classList.toggle('open');
    }

    function renderCurrentPage() {
      switch (currentPage) {
        case 'dashboard': renderDashboard(); break;
        case 'stock': renderStock(); break;
        case 'receive': filterReceiveHistory(); break;
        case 'issue': filterIssueHistory(); break;
        case 'stockByIV': loadStockByIV(); break;
        case 'movement': break;
        case 'master': renderMaster(); break;
      }
    }

    // Dashboard
    function renderDashboard() {
      document.getElementById('totalProducts').textContent = products.length.toLocaleString();
      
      let totalStock = 0;
      let lowStockCount = 0;
      const lowStockItems = [];

      products.forEach(p => {
        const stock = getProductStock(p.id);
        totalStock += stock;
        if (stock < (p.minStock || 10)) {
          lowStockCount++;
          lowStockItems.push({ ...p, stock });
        }
      });

      document.getElementById('totalStock').textContent = totalStock.toLocaleString();
      document.getElementById('lowStockCount').textContent = lowStockCount.toLocaleString();

      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const todayTx = transactions.filter(t => {
        const txDate = t.timestamp?.toDate ? t.timestamp.toDate() : new Date(t.timestamp);
        txDate.setHours(0, 0, 0, 0);
        return txDate.getTime() === today.getTime();
      });
      document.getElementById('todayTransactions').textContent = todayTx.length.toLocaleString();

      // Low stock list
      const lowStockList = document.getElementById('lowStockList');
      if (lowStockItems.length === 0) {
        lowStockList.innerHTML = '<p class="text-gray-400 text-center py-8">‚úÖ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ï‡πà‡∏≥</p>';
      } else {
        lowStockList.innerHTML = lowStockItems.slice(0, 10).map(item => `
          <div class="flex items-center justify-between p-3 bg-red-50 rounded-xl">
            <div>
              <p class="font-medium text-gray-800">${item.name}</p>
              <p class="text-xs text-gray-500">Min: ${item.minStock || 10} ${item.unit}</p>
            </div>
            <div class="text-right">
              <p class="text-lg font-bold text-red-600">${item.stock.toFixed(2)}</p>
              <p class="text-xs text-gray-500">${item.unit}</p>
            </div>
          </div>
        `).join('');
      }

      // Recent transactions
      const recentTx = document.getElementById('recentTransactions');
      if (transactions.length === 0) {
        recentTx.innerHTML = '<p class="text-gray-400 text-center py-8">ÔøΩÔøΩ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>';
      } else {
        const sortedTx = [...transactions].reverse();
        recentTx.innerHTML = sortedTx.slice(0, 10).map(t => {
          const date = t.timestamp?.toDate ? t.timestamp.toDate() : new Date(t.timestamp);
          const isReceive = t.type === 'receive';
          return `
            <div class="flex items-center justify-between p-3 ${isReceive ? 'bg-green-50' : 'bg-orange-50'} rounded-xl">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 ${isReceive ? 'bg-green-100 text-green-600' : 'bg-orange-100 text-orange-600'} rounded-full flex items-center justify-center">
                  ${isReceive ? '+' : '-'}
                </div>
                <div>
                  <p class="font-medium text-gray-800">${t.productName}</p>
                  <p class="text-xs text-gray-500">${date.toLocaleDateString('th-TH')} ${date.toLocaleTimeString('th-TH', {hour: '2-digit', minute:'2-digit'})}</p>
                </div>
              </div>
              <p class="font-bold ${isReceive ? 'text-green-600' : 'text-orange-600'}">${isReceive ? '+' : '-'}${t.qty.toFixed(2)}</p>
            </div>
          `;
        }).join('');
      }
    }

    // Stock Balance
    function renderStock() {
      const tbody = document.getElementById('stockTableBody');
      const cardView = document.getElementById('stockCardView');
      const searchTerm = document.getElementById('stockSearch').value.toLowerCase();

      let stockData = products.map(p => ({
        ...p,
        stock: getProductStock(p.id)
      }));

      if (searchTerm) {
        stockData = stockData.filter(s => s.name.toLowerCase().includes(searchTerm));
      }

      stockData.sort((a, b) => {
        if (stockSortField === 'name') {
          return stockSortAsc ? a.name.localeCompare(b.name, 'th') : b.name.localeCompare(a.name, 'th');
        } else {
          return stockSortAsc ? a.stock - b.stock : b.stock - a.stock;
        }
      });

      if (stockData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-12 text-center text-gray-400">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>';
        cardView.innerHTML = '<p class="text-gray-400 text-center py-12">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>';
        return;
      }

      // Desktop Table View
      tbody.innerHTML = stockData.map(s => {
        const isLow = s.stock < (s.minStock || 10);
        return `
          <tr class="table-row">
            <td class="px-6 py-4 font-medium text-gray-800">${s.name}</td>
            <td class="px-6 py-4 text-gray-600">${s.unit}</td>
            <td class="px-6 py-4 text-right font-semibold ${isLow ? 'text-red-600' : 'text-gray-800'}">${s.stock.toFixed(2)}</td>
            <td class="px-6 py-4 text-right text-gray-600">${s.minStock || 10}</td>
            <td class="px-6 py-4 text-center">
              <span class="status-badge ${isLow ? 'status-low' : 'status-normal'}">${isLow ? '‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ï‡πà‡∏≥' : '‡∏õ‡∏Å‡∏ï‡∏¥'}</span>
            </td>
          </tr>
        `;
      }).join('');

      // Mobile Card View
      cardView.innerHTML = stockData.map(s => {
        const isLow = s.stock < (s.minStock || 10);
        return `
          <div class="bg-white rounded-xl p-4 shadow-sm border ${isLow ? 'border-red-200' : 'border-gray-200'}">
            <div class="flex justify-between items-start mb-3">
              <h3 class="font-semibold text-gray-800 text-lg">${s.name}</h3>
              <span class="status-badge ${isLow ? 'status-low' : 'status-normal'}">${isLow ? '‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ï‡πà‡∏≥' : '‡∏õ‡∏Å‡∏ï‡∏¥'}</span>
            </div>
            <div class="grid grid-cols-2 gap-3">
              <div>
                <p class="text-xs text-gray-500">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏±‡∏ö</p>
                <p class="text-sm font-medium text-gray-700">${s.unit}</p>
              </div>
              <div>
                <p class="text-xs text-gray-500">‡∏à‡∏∏‡∏î‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</p>
                <p class="text-sm font-medium text-gray-700">${s.minStock || 10}</p>
              </div>
            </div>
            <div class="mt-3 pt-3 border-t border-gray-100">
              <p class="text-xs text-gray-500 mb-1">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</p>
              <p class="text-2xl font-bold ${isLow ? 'text-red-600' : 'text-gray-800'}">${s.stock.toFixed(2)} <span class="text-sm font-normal text-gray-500">${s.unit}</span></p>
            </div>
          </div>
        `;
      }).join('');
    }

    function filterStock() {
      renderStock();
    }

    function sortStock(field) {
      if (stockSortField === field) {
        stockSortAsc = !stockSortAsc;
      } else {
        stockSortField = field;
        stockSortAsc = true;
      }
      renderStock();
    }

    // Date parsing functions
    function parseExcelDate(value) {
      if (!value) return null;
      
      if (typeof value === 'number') {
        const excelEpoch = new Date(1899, 11, 30);
        const date = new Date(excelEpoch.getTime() + value * 86400000);
        return date;
      }
      
      if (typeof value === 'string') {
        const parts = value.split('-');
        if (parts.length === 3) {
          const day = parseInt(parts[0]);
          const month = parseInt(parts[1]) - 1;
          const year = parseInt(parts[2]);
          if (!isNaN(day) && !isNaN(month) && !isNaN(year)) {
            return new Date(year, month, day);
          }
        }
      }
      
      return null;
    }

    // Receive Functions
    function updateReceiveUnit() {
      const productId = document.getElementById('receiveProduct').value;
      const product = products.find(p => p.id === productId);
      document.getElementById('receiveUnit').value = product ? product.unit : '';
    }

    function downloadReceiveTemplate() {
      const template = [
        ['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (DD-MM-YYYY)', '‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô', '‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà PO', '‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà IV'],
        ['25-01-2025', 'ÔøΩÔøΩ‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', 100.50, 'PO001', 'IV001']
      ];
      const ws = XLSX.utils.aoa_to_sheet(template);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Template');
      XLSX.writeFile(wb, 'template_receive.xlsx');
    }

    function showReceiveConfirm() {
      const dateInput = document.getElementById('receiveDate').value;
      const productId = document.getElementById('receiveProduct').value;
      const qty = parseFloat(document.getElementById('receiveQty').value);
      const po = document.getElementById('receivePO').value.trim();
      const iv = document.getElementById('receiveIV').value.trim();
      const product = products.find(p => p.id === productId);

      if (!dateInput || !productId || !qty || !iv) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', 'error');
        return;
      }

      const [year, month, day] = dateInput.split('-');
      const displayDate = `${day}-${month}-${year}`;

      showConfirmModal(
        '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤',
        `
          <div class="space-y-3">
            <div class="flex justify-between py-2 border-b"><span class="text-gray-500">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</span><span class="font-medium">${displayDate}</span></div>
            <div class="flex justify-between py-2 border-b"><span class="text-gray-500">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤:</span><span class="font-medium">${product.name}</span></div>
            <div class="flex justify-between py-2 border-b"><span class="text-gray-500">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô:</span><span class="font-medium text-green-600">+${qty.toFixed(2)} ${product.unit}</span></div>
            <div class="flex justify-between py-2 border-b"><span class="text-gray-500">ÔøΩÔøΩÔøΩ‡∏•‡∏Ç‡∏ó‡∏µ‡πà PO:</span><span class="font-medium">${po || '-'}</span></div>
            <div class="flex justify-between py-2"><span class="text-gray-500">‡πÄ‡∏•ÔøΩÔøΩÔøΩ‡∏ó‡∏µ‡πà IV:</span><span class="font-medium">${iv}</span></div>
          </div>
        `,
        () => executeReceive(dateInput, productId, product.name, qty, po, iv),
        'btn-success'
      );
    }

    async function executeReceive(dateInput, productId, productName, qty, po, iv) {
      try {
        const selectedDate = new Date(dateInput + 'T00:00:00');
        await db.collection('transactions').add({
          type: 'receive',
          productId,
          productName,
          qty,
          po,
          iv,
          timestamp: firebase.firestore.Timestamp.fromDate(selectedDate),
          userId: currentUser.uid
        });
        showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≥‡πÄÔøΩÔøΩ‡πá‡∏à', 'success');
        clearReceiveForm();
      } catch (error) {
        showToast('‡πÄ‡∏ÅÔøΩÔøΩÔøΩ‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');
      }
    }

    function clearReceiveForm() {
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('receiveDate').value = today;
      document.getElementById('receiveProduct').value = '';
      document.getElementById('receiveUnit').value = '';
      document.getElementById('receiveQty').value = '';
      document.getElementById('receivePO').value = '';
      document.getElementById('receiveIV').value = '';
    }

    function handleReceiveExcel(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = async (e) => {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          const sheet = workbook.Sheets[workbook.SheetNames[0]];
          const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });

          const validRows = [];
          const errors = [];

          for (let i = 1; i < rows.length; i++) {
            const [dateValue, name, qty, po, iv] = rows[i];
            
            const parsedDate = parseExcelDate(dateValue);
            if (!parsedDate) {
              errors.push(`‡πÅ‡∏ñ‡∏ß ${i + 1}: ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (‡πÉ‡∏ä‡πâÔøΩÔøΩ‡∏π‡∏õ‡πÅ‡∏ö‡∏ö DD-MM-YYYY)`);
              continue;
            }
            
            if (!name || !qty || !iv) {
              errors.push(`‡πÅ‡∏ñ‡∏ß ${i + 1}: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö`);
              continue;
            }
            const product = products.find(p => p.name.toLowerCase() === String(name).toLowerCase());
            if (!product) {
              errors.push(`‡πÅ‡∏ñ‡∏ß ${i + 1}: ÔøΩÔøΩÔøΩ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâÔøΩÔøΩ "${name}"`);
              continue;
            }
            validRows.push({ 
              date: parsedDate,
              product, 
              qty: parseFloat(qty), 
              po: po || '', 
              iv: String(iv) 
            });
          }

          if (validRows.length === 0) {
            showToast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤ÔøΩÔøΩ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
            return;
          }

          const summary = validRows.map(r => `${r.date.toLocaleDateString('th-TH')}: ${r.product.name} +${r.qty.toFixed(2)}`).join('<br>');
          showConfirmModal(
            `‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ ${validRows.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`,
            `<div class="max-h-60 overflow-y-auto text-sm">${summary}</div>${errors.length ? `<p class="text-red-500 text-xs mt-2">${errors.length} ‡∏£‡∏≤‡∏¢ÔøΩÔøΩÔøΩ‡∏≤‡∏£‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</p>` : ''}`,
            async () => {
              for (const row of validRows) {
                await db.collection('transactions').add({
                  type: 'receive',
                  productId: row.product.id,
                  productName: row.product.name,
                  qty: row.qty,
                  po: row.po,
                  iv: row.iv,
                  timestamp: firebase.firestore.Timestamp.fromDate(row.date),
                  userId: currentUser.uid
                });
              }
              showToast(`‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${validRows.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`, 'success');
            },
            'btn-success'
          );
        } catch (error) {
          showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£ÔøΩÔøΩ‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå', 'error');
        }
      };
      reader.readAsArrayBuffer(file);
      event.target.value = '';
    }

    // Receive Filter Functions
    function toggleReceiveFilters() {
      const filters = document.getElementById('receiveFilters');
      filters.classList.toggle('hidden');
    }

    async function filterReceiveHistory() {
      // Reset pagination
      receiveAllDocs = [];
      receiveLastDoc = null;
      receiveHasMore = true;

      await loadReceiveHistory();
    }

    async function loadReceiveHistory() {
      const tbody = document.getElementById('receiveHistoryBody');
      const dateStart = document.getElementById('receiveFilterDateStart')?.value;
      const dateEnd = document.getElementById('receiveFilterDateEnd')?.value;
      const productFilter = document.getElementById('receiveFilterProduct')?.value.toLowerCase().trim();
      const ivFilter = document.getElementById('receiveFilterIV')?.value.toLowerCase().trim();
      const poFilter = document.getElementById('receiveFilterPO')?.value.toLowerCase().trim();

      try {
        // Query ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ where + orderBy ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á composite index
        let query = db.collection('transactions')
          .orderBy('timestamp', 'desc')
          .limit(50);

        if (receiveLastDoc) {
          query = query.startAfter(receiveLastDoc);
        }

        const snapshot = await query.get();

        if (snapshot.empty && receiveAllDocs.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-8 text-center text-gray-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td></tr>';
          document.getElementById('receiveLoadMoreBtn').classList.add('hidden');
          return;
        }

        receiveHasMore = snapshot.docs.length === 50;
        if (snapshot.docs.length > 0) {
          receiveLastDoc = snapshot.docs[snapshot.docs.length - 1];
        }

        const newDocs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        receiveAllDocs = [...receiveAllDocs, ...newDocs];

        // Apply filters - ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ type === 'receive' ‡πÅ‡∏•‡∏∞‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏≠‡∏∑‡πà‡∏ô‡πÜ
        let filteredDocs = receiveAllDocs.filter(t => t.type === 'receive');

        if (dateStart) {
          const startDate = new Date(dateStart);
          startDate.setHours(0, 0, 0, 0);
          filteredDocs = filteredDocs.filter(t => {
            const txDate = t.timestamp?.toDate ? t.timestamp.toDate() : new Date(t.timestamp);
            txDate.setHours(0, 0, 0, 0);
            return txDate >= startDate;
          });
        }

        if (dateEnd) {
          const endDate = new Date(dateEnd);
          endDate.setHours(23, 59, 59, 999);
          filteredDocs = filteredDocs.filter(t => {
            const txDate = t.timestamp?.toDate ? t.timestamp.toDate() : new Date(t.timestamp);
            return txDate <= endDate;
          });
        }

        if (productFilter) {
          filteredDocs = filteredDocs.filter(t => t.productName && t.productName.toLowerCase().includes(productFilter));
        }

        if (ivFilter) {
          filteredDocs = filteredDocs.filter(t => t.iv && t.iv.toLowerCase().includes(ivFilter));
        }

        if (poFilter) {
          filteredDocs = filteredDocs.filter(t => t.po && t.po.toLowerCase().includes(poFilter));
        }

        // Update count
        const countEl = document.getElementById('receiveFilterCount');
        if (countEl) {
          countEl.textContent = `‡πÅ‡∏™‡∏î‡∏á ${filteredDocs.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
        }

        // Update pagination button
        const loadMoreBtn = document.getElementById('receiveLoadMoreBtn');
        const currentCount = document.getElementById('receiveCurrentCount');
        const totalCount = document.getElementById('receiveTotalCount');

        if (currentCount) currentCount.textContent = receiveAllDocs.length;
        if (totalCount) totalCount.textContent = receiveHasMore ? `${receiveAllDocs.length}+` : receiveAllDocs.length;

        if (receiveHasMore) {
          loadMoreBtn.classList.remove('hidden');
        } else {
          loadMoreBtn.classList.add('hidden');
        }

        if (filteredDocs.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-8 text-center text-gray-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td></tr>';
          return;
        }

        tbody.innerHTML = filteredDocs.map(t => {
          const date = t.timestamp?.toDate ? t.timestamp.toDate() : new Date(t.timestamp);
          return `
            <tr class="table-row">
              <td class="px-6 py-3 text-gray-600">${date.toLocaleDateString('th-TH')} ${date.toLocaleTimeString('th-TH', {hour: '2-digit', minute:'2-digit'})}</td>
              <td class="px-6 py-3 font-medium text-gray-800">${t.productName}</td>
              <td class="px-6 py-3 text-right font-semibold text-green-600">+${t.qty.toFixed(2)}</td>
              <td class="px-6 py-3 text-gray-600">${t.po || '-'}</td>
              <td class="px-6 py-3 text-gray-600">${t.iv}</td>
              <td class="px-6 py-3 text-center">
                <div class="flex gap-2 justify-center">
                  <button onclick="showEditReceiveModal('${t.id}', ${t.qty})" class="px-3 py-1 bg-blue-100 text-blue-600 rounded-lg hover:bg-blue-200 transition-colors text-sm">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                  <button onclick="showDeleteTransactionConfirm('${t.id}', '${t.productName}', 'receive')" class="px-3 py-1 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 transition-colors text-sm">‡∏•‡∏ö</button>
                </div>
              </td>
            </tr>
          `;
        }).join('');
      } catch (error) {
        console.error('Error loading receive history:', error);
        tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-8 text-center text-red-400">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>';
      }
    }

    async function loadMoreReceive() {
      await loadReceiveHistory();
    }

    function clearReceiveFilters() {
      document.getElementById('receiveFilterDateStart').value = '';
      document.getElementById('receiveFilterDateEnd').value = '';
      document.getElementById('receiveFilterProduct').value = '';
      document.getElementById('receiveFilterIV').value = '';
      document.getElementById('receiveFilterPO').value = '';
      filterReceiveHistory();
    }

    function exportReceiveHistory() {
      const receiveTx = transactions.filter(t => t.type === 'receive');
      const data = receiveTx.map(t => {
        const date = t.timestamp?.toDate ? t.timestamp.toDate() : new Date(t.timestamp);
        return {
          '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà': date.toLocaleDateString('th-TH'),
          '‡πÄ‡∏ß‡∏•‡∏≤': date.toLocaleTimeString('th-TH'),
          '‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤': t.productName,
          '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô': t.qty.toFixed(2),
          'PO': t.po || '',
          'IV': t.iv
        };
      });
      exportToExcel(data, 'receive_history');
    }

    // Issue Functions
    function updateIssueIVOptions() {
      const productId = document.getElementById('issueProduct').value;
      const product = products.find(p => p.id === productId);
      const ivSelect = document.getElementById('issueIV');
      const infoDiv = document.getElementById('issueAvailableInfo');

      document.getElementById('issueUnit').value = product ? product.unit : '';

      if (!productId) {
        ivSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô --</option>';
        infoDiv.classList.add('hidden');
        return;
      }

      const productIVs = Object.values(stockByIV).filter(s => s.productId === productId && s.qty > 0);

      if (productIVs.length === 0) {
        ivSelect.innerHTML = '<option value="">-- ‡πÑ‡∏°‡πà‡∏°‡∏µ IV ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ç‡∏≠‡∏á --</option>';
        infoDiv.innerHTML = '‚ö†Ô∏è ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠';
        infoDiv.classList.remove('hidden');
        return;
      }

      ivSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å IV --</option>' + 
        productIVs.map(s => `<option value="${s.iv}" data-qty="${s.qty}">${s.iv} (‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${s.qty.toFixed(2)})</option>`).join('');

      infoDiv.classList.add('hidden');

      ivSelect.onchange = () => {
        const selectedOption = ivSelect.options[ivSelect.selectedIndex];
        if (selectedOption.dataset.qty) {
          infoDiv.innerHTML = `üì¶ IV: ${ivSelect.value} ‡∏°‡∏µ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${parseFloat(selectedOption.dataset.qty).toFixed(2)} ${product.unit}`;
          infoDiv.classList.remove('hidden');
        } else {
          infoDiv.classList.add('hidden');
        }
      };
    }

    function downloadIssueTemplate() {
      const template = [
        ['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (DD-MM-YYYY)', '‡∏ä‡∏∑‡πà‡∏≠ÔøΩÔøΩ‡∏¥ÔøΩÔøΩÔøΩÔøΩÔøΩ‡πâ‡∏≤', '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô', '‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà IV', 'ÔøΩÔøΩÔøΩ‡∏•‡∏Ç‡∏ó‡∏µÔøΩÔøΩÔøΩÔøΩ‡πÄ‡∏≠‡∏Å‡∏™ÔøΩÔøΩ‡∏£'],
        ['25-01-2025', '‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', 50.25, 'IV001', 'DOC001']
      ];
      const ws = XLSX.utils.aoa_to_sheet(template);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Template');
      XLSX.writeFile(wb, 'template_issue.xlsx');
    }

    function showIssueConfirm() {
      const dateInput = document.getElementById('issueDate').value;
      const productId = document.getElementById('issueProduct').value;
      const iv = document.getElementById('issueIV').value;
      const qty = parseFloat(document.getElementById('issueQty').value);
      const docNo = document.getElementById('issueDocNo').value.trim();
      const product = products.find(p => p.id === productId);

      if (!dateInput || !productId || !iv || !qty) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñÔøΩÔøΩÔøΩÔøΩÔøΩ‡∏ß‡∏ô', 'error');
        return;
      }

            const ivStock = stockByIV[`${productId}_${iv}`];
      if (!ivStock || ivStock.qty < qty) {
        showToast(`‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡∏°‡∏µ (‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${ivStock?.qty.toFixed(2) || 0})`, 'error');
        return;
      }

      const [year, month, day] = dateInput.split('-');
      const displayDate = `${day}-${month}-${year}`;

      showConfirmModal(
        '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢‡∏≠ÔøΩÔøΩ‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤',
        `
          <div class="space-y-3">
            <div class="flex justify-between py-2 border-b"><span class="text-gray-500">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</span><span class="font-medium">${displayDate}</span></div>
            <div class="flex justify-between py-2 border-b"><span class="text-gray-500">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤:</span><span class="font-medium">${product.name}</span></div>
            <div class="flex justify-between py-2 border-b"><span class="text-gray-500">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà IV:</span><span class="font-medium">${iv}</span></div>
            <div class="flex justify-between py-2 border-b"><span class="text-gray-500">‡∏à‡∏≥ÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩ‡∏ô:</span><span class="font-medium text-red-600">-${qty.toFixed(2)} ${product.unit}</span></div>
            <div class="flex justify-between py-2 border-b"><span class="text-gray-500">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£:</span><span class="font-medium">${docNo || '-'}</span></div>
            <div class="flex justify-between py-2"><span class="text-gray-500">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏´‡∏•‡∏±‡∏á‡∏à‡πà‡∏≤‡∏¢:</span><span class="font-medium">${(ivStock.qty - qty).toFixed(2)} ${product.unit}</span></div>
          </div>
        `,
        () => executeIssue(dateInput, productId, product.name, qty, iv, docNo),
        'btn-danger'
      );
    }

    async function executeIssue(dateInput, productId, productName, qty, iv, docNo) {
      try {
        const selectedDate = new Date(dateInput + 'T00:00:00');
        await db.collection('transactions').add({
          type: 'issue',
          productId,
          productName,
          qty,
          iv,
          docNo,
          timestamp: firebase.firestore.Timestamp.fromDate(selectedDate),
          userId: currentUser.uid
        });
        showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
        clearIssueForm();
      } catch (error) {
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');
      }
    }

    function clearIssueForm() {
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('issueDate').value = today;
      document.getElementById('issueProduct').value = '';
      document.getElementById('issueIV').innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô --</option>';
      document.getElementById('issueUnit').value = '';
      document.getElementById('issueQty').value = '';
      document.getElementById('issueDocNo').value = '';
      document.getElementById('issueAvailableInfo').classList.add('hidden');
    }

    function handleIssueExcel(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = async (e) => {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          const sheet = workbook.Sheets[workbook.SheetNames[0]];
          const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });

          const validRows = [];
          const errors = [];

          for (let i = 1; i < rows.length; i++) {
            const [dateValue, name, qty, iv, docNo] = rows[i];
            
            const parsedDate = parseExcelDate(dateValue);
            if (!parsedDate) {
              errors.push(`‡πÅ‡∏ñ‡∏ß ${i + 1}: ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑÔøΩÔøΩ‡πàÔøΩÔøΩ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ‡πÅ‡∏öÔøΩÔøΩÔøΩ DD-MM-YYYY)`);
              continue;
            }
            
            if (!name || !qty || !iv) {
              errors.push(`‡πÅ‡∏ñ‡∏ß ${i + 1}: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö`);
              continue;
            }
            const product = products.find(p => p.name.toLowerCase() === String(name).toLowerCase());
            if (!product) {
              errors.push(`‡πÅ‡∏ñ‡∏ß ${i + 1}: ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ "${name}"`);
              continue;
            }
            const currentStock = getProductStock(product.id);
            if (currentStock < parseFloat(qty)) {
              errors.push(`‡πÅ‡∏ñ‡∏ß ${i + 1}: ${name} ‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏û‡∏≠ (‡∏°‡∏µ ${currentStock.toFixed(2)})`);
              continue;
            }
            validRows.push({ 
              date: parsedDate,
              product, 
              qty: parseFloat(qty), 
              iv: String(iv),
              docNo: docNo || ''
            });
          }

          if (validRows.length === 0) {
            showToast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
            return;
          }

          const summary = validRows.map(r => `${r.date.toLocaleDateString('th-TH')}: ${r.product.name} -${r.qty.toFixed(2)}`).join('<br>');
          showConfirmModal(
            `‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å ${validRows.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`,
            `<div class="max-h-60 overflow-y-auto text-sm">${summary}</div>${errors.length ? `<p class="text-red-500 text-xs mt-2">${errors.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</p>` : ''}<p class="text-orange-500 text-xs mt-2">‚ö†Ô∏è ÔøΩÔøΩ‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î Excel ‡πÄ‡∏ä‡πá‡∏Ñ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° ‡πÑ‡∏°‡πà‡πÅ‡∏¢‡∏Å IV</p>`,
            async () => {
              for (const row of validRows) {
                await db.collection('transactions').add({
                  type: 'issue',
                  productId: row.product.id,
                  productName: row.product.name,
                  qty: row.qty,
                  iv: row.iv,
                  docNo: row.docNo,
                  timestamp: firebase.firestore.Timestamp.fromDate(row.date),
                  userId: currentUser.uid
                });
              }
              showToast(`‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${validRows.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`, 'success');
            },
            'btn-danger'
          );
        } catch (error) {
          showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏ÇÔøΩÔøΩÔøΩ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤ÔøΩÔøΩÔøΩ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå', 'error');
        }
      };
      reader.readAsArrayBuffer(file);
      event.target.value = '';
    }

    // Issue Filter Functions
    function toggleIssueFilters() {
      const filters = document.getElementById('issueFilters');
      filters.classList.toggle('hidden');
    }

    async function filterIssueHistory() {
      // Reset pagination
      issueAllDocs = [];
      issueLastDoc = null;
      issueHasMore = true;

      await loadIssueHistory();
    }

    async function loadIssueHistory() {
      const tbody = document.getElementById('issueHistoryBody');
      const dateStart = document.getElementById('issueFilterDateStart')?.value;
      const dateEnd = document.getElementById('issueFilterDateEnd')?.value;
      const productFilter = document.getElementById('issueFilterProduct')?.value.toLowerCase().trim();
      const ivFilter = document.getElementById('issueFilterIV')?.value.toLowerCase().trim();
      const docNoFilter = document.getElementById('issueFilterDocNo')?.value.toLowerCase().trim();

      try {
        // Query ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ where + orderBy ‡∏ó‡∏µ‡πà‡∏ïÔøΩÔøΩ‡∏≠‡∏á composite index
        let query = db.collection('transactions')
          .orderBy('timestamp', 'desc')
          .limit(50);

        if (issueLastDoc) {
          query = query.startAfter(issueLastDoc);
        }

        const snapshot = await query.get();

        if (snapshot.empty && issueAllDocs.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-8 text-center text-gray-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td></tr>';
          document.getElementById('issueLoadMoreBtn').classList.add('hidden');
          return;
        }

        issueHasMore = snapshot.docs.length === 50;
        if (snapshot.docs.length > 0) {
          issueLastDoc = snapshot.docs[snapshot.docs.length - 1];
        }

        const newDocs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        issueAllDocs = [...issueAllDocs, ...newDocs];

        // Apply filters - ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ type === 'issue' ‡πÅ‡∏•‡∏∞‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏≠‡∏∑‡πà‡∏ô‡πÜ
        let filteredDocs = issueAllDocs.filter(t => t.type === 'issue');

        if (dateStart) {
          const startDate = new Date(dateStart);
          startDate.setHours(0, 0, 0, 0);
          filteredDocs = filteredDocs.filter(t => {
            const txDate = t.timestamp?.toDate ? t.timestamp.toDate() : new Date(t.timestamp);
            txDate.setHours(0, 0, 0, 0);
            return txDate >= startDate;
          });
        }

        if (dateEnd) {
          const endDate = new Date(dateEnd);
          endDate.setHours(23, 59, 59, 999);
          filteredDocs = filteredDocs.filter(t => {
            const txDate = t.timestamp?.toDate ? t.timestamp.toDate() : new Date(t.timestamp);
            return txDate <= endDate;
          });
        }

        if (productFilter) {
          filteredDocs = filteredDocs.filter(t => t.productName && t.productName.toLowerCase().includes(productFilter));
        }

        if (ivFilter) {
          filteredDocs = filteredDocs.filter(t => t.iv && t.iv.toLowerCase().includes(ivFilter));
        }

        if (docNoFilter) {
          filteredDocs = filteredDocs.filter(t => t.docNo && t.docNo.toLowerCase().includes(docNoFilter));
        }

        // Update count
        const countEl = document.getElementById('issueFilterCount');
        if (countEl) {
          countEl.textContent = `‡πÅ‡∏™‡∏î‡∏á ${filteredDocs.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
        }

        // Update pagination button
        const loadMoreBtn = document.getElementById('issueLoadMoreBtn');
        const currentCount = document.getElementById('issueCurrentCount');
        const totalCount = document.getElementById('issueTotalCount');

        if (currentCount) currentCount.textContent = issueAllDocs.length;
        if (totalCount) totalCount.textContent = issueHasMore ? `${issueAllDocs.length}+` : issueAllDocs.length;

        if (issueHasMore) {
          loadMoreBtn.classList.remove('hidden');
        } else {
          loadMoreBtn.classList.add('hidden');
        }

        if (filteredDocs.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-8 text-center text-gray-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td></tr>';
          return;
        }

        tbody.innerHTML = filteredDocs.map(t => {
          const date = t.timestamp?.toDate ? t.timestamp.toDate() : new Date(t.timestamp);
          return `
            <tr class="table-row">
              <td class="px-6 py-3 text-gray-600">${date.toLocaleDateString('th-TH')} ${date.toLocaleTimeString('th-TH', {hour: '2-digit', minute:'2-digit'})}</td>
              <td class="px-6 py-3 font-medium text-gray-800">${t.productName}</td>
              <td class="px-6 py-3 text-right font-semibold text-red-600">-${t.qty.toFixed(2)}</td>
              <td class="px-6 py-3 text-gray-600">${t.iv}</td>
              <td class="px-6 py-3 text-gray-600">${t.docNo || '-'}</td>
              <td class="px-6 py-3 text-center">
                <div class="flex gap-2 justify-center">
                  <button onclick="showEditIssueModal('${t.id}', ${t.qty})" class="px-3 py-1 bg-blue-100 text-blue-600 rounded-lg hover:bg-blue-200 transition-colors text-sm">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                  <button onclick="showDeleteTransactionConfirm('${t.id}', '${t.productName}', 'issue')" class="px-3 py-1 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 transition-colors text-sm">‡∏•‡∏ö</button>
                </div>
              </td>
            </tr>
          `;
        }).join('');
      } catch (error) {
        console.error('Error loading issue history:', error);
        tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-8 text-center text-red-400">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>';
      }
    }

    async function loadMoreIssue() {
      await loadIssueHistory();
    }

    function clearIssueFilters() {
      document.getElementById('issueFilterDateStart').value = '';
      document.getElementById('issueFilterDateEnd').value = '';
      document.getElementById('issueFilterProduct').value = '';
      document.getElementById('issueFilterIV').value = '';
      document.getElementById('issueFilterDocNo').value = '';
      filterIssueHistory();
    }

    function exportIssueHistory() {
      const issueTx = transactions.filter(t => t.type === 'issue');
      const data = issueTx.map(t => {
        const date = t.timestamp?.toDate ? t.timestamp.toDate() : new Date(t.timestamp);
        return {
          '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà': date.toLocaleDateString('th-TH'),
          '‡πÄ‡∏ß‡∏•‡∏≤': date.toLocaleTimeString('th-TH'),
          '‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤': t.productName,
          '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô': t.qty.toFixed(2),
          'IV': t.iv,
          '‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£': t.docNo || ''
        };
      });
      exportToExcel(data, 'issue_history');
    }

    // Stock by IV
    function loadStockByIV() {
      const productId = document.getElementById('stockByIVProduct').value;
      const ivSelect = document.getElementById('stockByIVSelect');
      
      let ivData = Object.values(stockByIV).filter(s => s.qty > 0);
      
      if (productId) {
        ivData = ivData.filter(s => s.productId === productId);
      }

      const uniqueIVs = [...new Set(ivData.map(s => s.iv))];
      ivSelect.innerHTML = '<option value="">-- ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î --</option>' + 
        uniqueIVs.map(iv => `<option value="${iv}">${iv}</option>`).join('');

      filterStockByIV();
    }

    function filterStockByIV() {
      const productId = document.getElementById('stockByIVProduct').value;
      const selectedIV = document.getElementById('stockByIVSelect').value;
      const content = document.getElementById('stockByIVContent');

      let ivData = Object.values(stockByIV).filter(s => s.qty > 0);

      if (productId) {
        ivData = ivData.filter(s => s.productId === productId);
      }

      if (selectedIV) {
        ivData = ivData.filter(s => s.iv === selectedIV);
      }

      if (ivData.length === 0) {
        content.innerHTML = '<p class="text-gray-400 text-center py-12 col-span-full">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>';
        return;
      }

      // Group by product
      const grouped = {};
      ivData.forEach(s => {
        if (!grouped[s.productId]) {
          grouped[s.productId] = {
            productName: s.productName,
            ivs: []
          };
        }
        grouped[s.productId].ivs.push({ iv: s.iv, qty: s.qty });
      });

      Object.values(grouped).forEach(g => {
        g.ivs.sort((a, b) => a.iv.localeCompare(b.iv, 'th', { numeric: true, sensitivity: 'base' }));
      });

      const sortedGroups = Object.values(grouped).sort((a, b) => 
        a.productName.localeCompare(b.productName, 'th', { numeric: true, sensitivity: 'base' })
      );

      content.innerHTML = sortedGroups.map(g => `
        <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
          <h4 class="font-semibold text-gray-800 mb-4 pb-3 border-b">${g.productName}</h4>
          <div class="space-y-2">
            ${g.ivs.map(iv => `
              <div class="flex justify-between items-center p-3 bg-gray-50 rounded-xl">
                <span class="text-gray-600">IV: ${iv.iv}</span>
                <span class="font-bold text-blue-600">${iv.qty.toFixed(2)}</span>
              </div>
            `).join('')}
          </div>
          <div class="mt-4 pt-3 border-t flex justify-between">
            <span class="font-medium text-gray-600">‡∏£‡∏ß‡∏°</span>
            <span class="font-bold text-gray-800">${g.ivs.reduce((sum, iv) => sum + iv.qty, 0).toFixed(2)}</span>
          </div>
        </div>
      `).join('');
    }

    // Movement
    async function loadMovement() {
      const productId = document.getElementById('movementProduct').value;
      const summaryDiv = document.getElementById('movementSummary');
      const tbody = document.getElementById('movementTableBody');

      // Reset pagination
      movementAllDocs = [];
      movementLastDoc = null;
      movementHasMore = true;

      if (!productId) {
        summaryDiv.classList.add('hidden');
        tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-12 text-center text-gray-400">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß</td></tr>';
        document.getElementById('movementLoadMoreBtn').classList.add('hidden');
        return;
      }

      const product = products.find(p => p.id === productId);
      const currentStock = getProductStock(productId);

      document.getElementById('movementProductName').textContent = product.name;
      document.getElementById('movementBalance').textContent = currentStock.toFixed(2) + ' ' + product.unit;
      summaryDiv.classList.remove('hidden');

      await loadMovementData(productId);
    }

    async function loadMovementData(productId) {
      const tbody = document.getElementById('movementTableBody');

      try {
        let query = db.collection('transactions')
          .where('productId', '==', productId)
          .orderBy('timestamp', 'asc')
          .limit(50);

        if (movementLastDoc) {
          query = query.startAfter(movementLastDoc);
        }

        const snapshot = await query.get();

        if (snapshot.empty && movementAllDocs.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-12 text-center text-gray-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß</td></tr>';
          document.getElementById('movementLoadMoreBtn').classList.add('hidden');
          return;
        }

        movementHasMore = snapshot.docs.length === 50;
        if (snapshot.docs.length > 0) {
          movementLastDoc = snapshot.docs[snapshot.docs.length - 1];
        }

        const newDocs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        movementAllDocs = [...movementAllDocs, ...newDocs];

        // Update pagination button
        const loadMoreBtn = document.getElementById('movementLoadMoreBtn');
        const currentCount = document.getElementById('movementCurrentCount');
        const totalCount = document.getElementById('movementTotalCount');

        if (currentCount) currentCount.textContent = movementAllDocs.length;
        if (totalCount) totalCount.textContent = movementHasMore ? `${movementAllDocs.length}+` : movementAllDocs.length;

        if (movementHasMore) {
          loadMoreBtn.classList.remove('hidden');
        } else {
          loadMoreBtn.classList.add('hidden');
        }

        // Calculate running balance
        let runningBalance = 0;
        const rows = movementAllDocs.map(t => {
          const date = t.timestamp?.toDate ? t.timestamp.toDate() : new Date(t.timestamp);
          const isReceive = t.type === 'receive';
          runningBalance += isReceive ? t.qty : -t.qty;
          return {
            date,
            type: isReceive ? '‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤' : '‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å',
            isReceive,
            qty: t.qty,
            ref: isReceive ? `PO: ${t.po || '-'} / IV: ${t.iv}` : `IV: ${t.iv}`,
            balance: runningBalance
          };
        });

        tbody.innerHTML = rows.reverse().map(r => `
          <tr class="table-row">
            <td class="px-6 py-3 text-gray-600">${r.date.toLocaleDateString('th-TH')} ${r.date.toLocaleTimeString('th-TH', {hour: '2-digit', minute:'2-digit'})}</td>
            <td class="px-6 py-3 text-center">
              <span class="px-3 py-1 rounded-full text-xs font-medium ${r.isReceive ? 'bg-green-100 text-green-700' : 'bg-orange-100 text-orange-700'}">${r.type}</span>
            </td>
            <td class="px-6 py-3 text-right font-semibold ${r.isReceive ? 'text-green-600' : 'text-red-600'}">${r.isReceive ? '+' : '-'}${r.qty.toFixed(2)}</td>
            <td class="px-6 py-3 text-gray-600 text-sm">${r.ref}</td>
            <td class="px-6 py-3 text-right font-medium text-gray-800">${r.balance.toFixed(2)}</td>
          </tr>
        `).join('');
      } catch (error) {
        console.error('Error loading movement:', error);
        tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-12 text-center text-red-400">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´ÔøΩÔøΩÔøΩ‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>';
      }
    }

    async function loadMoreMovement() {
      const productId = document.getElementById('movementProduct').value;
      if (productId) {
        await loadMovementData(productId);
      }
    }

    // Master Data
    function showAddProductConfirm() {
      const name = document.getElementById('newProductName').value.trim();
      const unit = document.getElementById('newProductUnit').value.trim();
      const minStock = parseInt(document.getElementById('newProductMinStock').value) || 10;

      if (!name || !unit) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏™ÔøΩÔøΩÔøΩ‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏±‡∏ö', 'error');
        return;
      }

      if (products.some(p => p.name.toLowerCase() === name.toLowerCase())) {
        showToast('‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâÔøΩÔøΩÔøΩ‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß', 'error');
        return;
      }

      showConfirmModal(
        '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥ÔøΩÔøΩÔøΩÔøΩ‡πâ‡∏≤',
        `
          <div class="space-y-3">
            <div class="flex justify-between py-2 border-b"><span class="text-gray-500">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤:</span><span class="font-medium">${name}</span></div>
            <div class="flex justify-between py-2 border-b"><span class="text-gray-500">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏±‡∏ö:</span><span class="font-medium">${unit}</span></div>
            <div class="flex justify-between py-2"><span class="text-gray-500">‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥:</span><span class="font-medium">${minStock}</span></div>
          </div>
        `,
        () => executeAddProduct(name, unit, minStock),
        'btn-primary'
      );
    }

    async function executeAddProduct(name, unit, minStock) {
      try {
        await db.collection('products').add({
          name,
          unit,
          minStock,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        showToast('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥ÔøΩÔøΩ‡∏Ñ‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
        document.getElementById('newProductName').value = '';
        document.getElementById('newProductUnit').value = '';
        document.getElementById('newProductMinStock').value = '10';
      } catch (error) {
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');
      }
    }

    function renderMaster() {
      const tbody = document.getElementById('masterTableBody');
      const searchTerm = document.getElementById('masterSearch').value.toLowerCase();

      let filteredProducts = products;
      if (searchTerm) {
        filteredProducts = products.filter(p => p.name.toLowerCase().includes(searchTerm));
      }

      if (filteredProducts.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="px-6 py-8 text-center text-gray-400">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>';
        return;
      }

      tbody.innerHTML = filteredProducts.map(p => `
        <tr class="table-row">
          <td class="px-6 py-4 font-medium text-gray-800">${p.name}</td>
          <td class="px-6 py-4 text-gray-600">${p.unit}</td>
          <td class="px-6 py-4 text-right">
            <input type="number" value="${p.minStock || 10}" min="0" 
              class="w-20 px-2 py-1 border rounded text-right" 
              onchange="updateMinStock('${p.id}', this.value)">
          </td>
          <td class="px-6 py-4 text-center">
            <button onclick="showDeleteProductConfirm('${p.id}', '${p.name}')" class="px-3 py-1 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 transition-colors text-sm">
              ‡∏•‡∏ö
            </button>
          </td>
        </tr>
      `).join('');
    }

    function filterMaster() {
      renderMaster();
    }

    async function updateMinStock(productId, value) {
      try {
        await db.collection('products').doc(productId).update({
          minStock: parseInt(value) || 10
        });
        showToast('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏≥‡πÄ‡∏£‡πáÔøΩÔøΩÔøΩ', 'success');
      } catch (error) {
        showToast('‡πÄ‡∏Å‡∏¥‡∏îÔøΩÔøΩ‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error');
      }
    }

    function showDeleteProductConfirm(productId, productName) {
      showConfirmModal(
        '‚ö†Ô∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤',
        `
          <div class="text-center">
            <p class="text-lg font-medium text-gray-800 mb-2">${productName}</p>
            <p class="text-red-600 text-sm">‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏àÔøΩÔøΩ‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏î‡πâ‡∏ß‡∏¢!</p>
          </div>
        `,
        () => executeDeleteProduct(productId),
        'btn-danger'
      );
    }

    async function executeDeleteProduct(productId) {
      try {
        await db.collection('products').doc(productId).delete();
        
        const txSnapshot = await db.collection('transactions').where('productId', '==', productId).get();
        const batch = db.batch();
        txSnapshot.docs.forEach(doc => batch.delete(doc.ref));
        await batch.commit();

        showToast('‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
      } catch (error) {
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');
      }
    }

    function handleMasterExcel(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = async (e) => {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          const sheet = workbook.Sheets[workbook.SheetNames[0]];
          const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });

          const validRows = [];
          const errors = [];

          for (let i = 1; i < rows.length; i++) {
            const [name, unit, minStock] = rows[i];
            if (!name || !unit) {
              errors.push(`‡πÅ‡∏ñ‡∏ß ${i + 1}: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö`);
              continue;
            }
            if (products.some(p => p.name.toLowerCase() === String(name).toLowerCase())) {
              errors.push(`‡πÅ‡∏ñ‡∏ß ${i + 1}: "${name}" ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß`);
              continue;
            }
            validRows.push({ name: String(name), unit: String(unit), minStock: parseInt(minStock) || 10 });
          }

          if (validRows.length === 0) {
            showToast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏ÅÔøΩÔøΩÔøΩ‡∏£‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
            return;
          }

          const summary = validRows.map(r => `${r.name} (${r.unit})`).join('<br>');
          showConfirmModal(
            `‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ ${validRows.length} ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤`,
            `<div class="max-h-60 overflow-y-auto text-sm">${summary}</div>${errors.length ? `<p class="text-red-500 text-xs mt-2">${errors.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</p>` : ''}`,
            async () => {
              for (const row of validRows) {
                await db.collection('products').add({
                  name: row.name,
                  unit: row.unit,
                  minStock: row.minStock,
                  createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
              }
              showToast(`‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${validRows.length} ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤`, 'success');
            },
            'btn-primary'
          );
        } catch (error) {
          showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå', 'error');
        }
      };
      reader.readAsArrayBuffer(file);
      event.target.value = '';
    }

    function exportMasterData() {
      const data = products.map(p => ({
        '‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤': p.name,
        '‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏±‡∏ö': p.unit,
        '‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥': p.minStock || 10
      }));
      exportToExcel(data, 'master_data');
    }

    // Modal Functions
    function showConfirmModal(title, content, onConfirm, btnClass = 'btn-primary') {
      document.getElementById('confirmModalTitle').textContent = title;
      document.getElementById('confirmModalBody').innerHTML = content;
      const confirmBtn = document.getElementById('confirmModalBtn');
      confirmBtn.className = `${btnClass} px-6 py-2 text-white font-medium rounded-xl`;
      confirmBtn.onclick = () => {
        closeConfirmModal();
        onConfirm();
      };
      document.getElementById('confirmModal').classList.remove('hidden');
    }

    function closeConfirmModal() {
      document.getElementById('confirmModal').classList.add('hidden');
    }

    // Toast Functions
    function showToast(message, type = 'info') {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
      toast.className = `toast ${bgColor} text-white px-6 py-3 rounded-xl shadow-lg flex items-center gap-3`;
      toast.innerHTML = `
        <span>${type === 'success' ? '‚úì' : type === 'error' ? '‚úï' : '‚Ñπ'}</span>
        <span>${message}</span>
      `;
      container.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    // Excel Export
    function exportToExcel(data, filename) {
      const ws = XLSX.utils.json_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Sheet1');
      XLSX.writeFile(wb, `${filename}_${new Date().toISOString().split('T')[0]}.xlsx`);
    }

    // Edit and Delete Transaction Functions
    function showEditReceiveModal(txId, currentQty) {
      const tx = transactions.find(t => t.id === txId);
      if (!tx) return;

      showConfirmModal(
        '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤',
        `
          <div class="space-y-4">
            <div class="flex justify-between py-2 border-b">
              <span class="text-gray-500">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤:</span>
              <span class="font-medium">${tx.productName}</span>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÉ‡∏´‡∏°‡πà</label>
              <input type="number" id="editQtyInput" value="${currentQty}" min="0.01" step="0.01" class="input-field w-full px-4 py-3 rounded-xl outline-none">
            </div>
          </div>
        `,
        () => {
          const newQty = parseFloat(document.getElementById('editQtyInput').value);
          if (!newQty || newQty <= 0) {
            showToast('ÔøΩÔøΩÔøΩ‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πàÔøΩÔøΩ‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
            return;
          }
          executeEditTransaction(txId, newQty);
        },
        'btn-primary'
      );
    }

    function showEditIssueModal(txId, currentQty) {
      const tx = transactions.find(t => t.id === txId);
      if (!tx) return;

      showConfirmModal(
        '‡πÅ‡∏Å‡πâ‡πÑ‡∏ÇÔøΩÔøΩÔøΩ‡∏≥‡∏ô‡∏ß‡∏ô‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å',
        `
          <div class="space-y-4">
            <div class="flex justify-between py-2 border-b">
              <span class="text-gray-500">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤:</span>
              <span class="font-medium">${tx.productName}</span>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÉ‡∏´‡∏°‡πà</label>
              <input type="number" id="editQtyInput" value="${currentQty}" min="0.01" step="0.01" class="input-field w-full px-4 py-3 rounded-xl outline-none">
            </div>
          </div>
        `,
        () => {
          const newQty = parseFloat(document.getElementById('editQtyInput').value);
          if (!newQty || newQty <= 0) {
            showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
            return;
          }
          executeEditTransaction(txId, newQty);
        },
        'btn-primary'
      );
    }

    async function executeEditTransaction(txId, newQty) {
      try {
        await db.collection('transactions').doc(txId).update({
          qty: newQty
        });
        showToast('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
      } catch (error) {
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');
      }
    }

    function showDeleteTransactionConfirm(txId, productName, type) {
      const typeLabel = type === 'receive' ? '‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤' : '‡∏à‡πà‡∏≤ÔøΩÔøΩ‡∏≠‡∏≠‡∏Å';
      showConfirmModal(
        `‚ö†Ô∏è ‡∏¢ÔøΩÔøΩÔøΩ‡∏ô‡∏¢‡∏±ÔøΩÔøΩ‡∏Å‡∏≤‡∏£‡∏•‡∏öÔøΩÔøΩ‡∏≤‡∏¢‡∏Å‡∏≤‡∏£${typeLabel}`,
        `
          <div class="text-center">
            <p class="text-lg font-medium text-gray-800 mb-2">${productName}</p>
            <p class="text-red-600 text-sm">‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏™‡πà‡∏á‡∏ú‡∏•‡∏ï‡πà‡∏≠‡∏¢‡∏≠‡∏î‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î!</p>
          </div>
        `,
        () => executeDeleteTransaction(txId),
        'btn-danger'
      );
    }

    async function executeDeleteTransaction(txId) {
      try {
        await db.collection('transactions').doc(txId).delete();
        showToast('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
      } catch (error) {
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');
      }
    }

    // Close modal on outside click
    document.getElementById('confirmModal').addEventListener('click', (e) => {
      if (e.target.id === 'confirmModal') closeConfirmModal();
    });
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9c15d6cac464d32c',t:'MTc2ODk4ODMxMC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
